<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İstanbul Vali Koordinatörü Yardım Hattı</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'turquoise': {
                            50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 300: '#5eead4',
                            400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e',
                            800: '#115e59', 900: '#134e4a'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        @keyframes gradient-move {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, #23a6d5, #23d5ab, #e73c7e, #ee7752);
            background-size: 400% 400%;
            animation: gradient-move 15s ease infinite;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.5);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        }

        .dark-mode .glass-panel {
            background: rgba(29, 38, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        
        .dark-mode { background: #0f172a; }
        .dark-mode .text-gray-900 { color: #f8fafc !important; }
        .dark-mode .text-gray-800 { color: #e5e7eb !important; }
        .dark-mode .text-gray-700 { color: #d1d5db !important; }
        .dark-mode .text-gray-600 { color: #94a3b8 !important; }
        .dark-mode .border-gray-200 { border-color: #374151 !important; }
        .dark-mode .border-gray-300 { border-color: #334155 !important; }
        .dark-mode input, .dark-mode textarea, .dark-mode select { background-color: rgba(51, 65, 85, 0.5) !important; color: #f8fafc !important; border-color: #475569 !important; }
        .dark-mode .bg-gray-50 { background-color: rgba(55, 65, 81, 0.7) !important; color: #e5e7eb; }
        .dark-mode .bg-gray-100 { background-color: rgba(55, 65, 81, 0.5) !important; }
        .fixed-notification { position: fixed; top: 1rem; right: 1rem; z-index: 1050; }
        .nav-link { transition: all 0.3s ease; }
        .nav-link:hover { transform: translateY(-2px); color: #14b8a6 }
        .nav-link.active { background-color: #14b8a6; color: white !important; box-shadow: 0 4px 14px 0 rgba(20, 184, 166, 0.3); }
        .admin-only { display: none; }
        .admin-visible { display: block !important; }
        .status-badge { padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; text-transform: capitalize; }
        .status-new { background-color: #e0f2fe; color: #0c4a6e; }
        .status-inProgress { background-color: #fef9c3; color: #713f12; }
        .status-appointment { background-color: #e0e7ff; color: #312e81; }
        .status-completed { background-color: #dcfce7; color: #15803d; }
        .status-cancelled { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Firebase SDK (Uyumluluk Versiyonu) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <!-- Header -->
    <header class="sticky top-0 z-40 glass-panel">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-turquoise-600 p-3 rounded-full shadow-lg">
                        <i class="fas fa-hands-holding-child text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900">İstanbul Vali Koordinatörü Yardım Hattı</h1>
                        <p class="text-gray-800 mt-1">Anadolu Yakası Koordinasyon ve Destek Sistemi</p>
                    </div>
                </div>
                <div class="mt-4 md:mt-0 flex items-center space-x-4">
                    <button id="themeToggle" class="p-2 rounded-full glass-panel hover:bg-gray-200/50 transition-colors"><i class="fas fa-moon text-gray-800"></i></button>
                    <button id="adminLoginBtn" class="p-2 rounded-full glass-panel hover:bg-gray-200/50 transition-colors"><i class="fas fa-lock text-turquoise-600"></i></button>
                </div>
            </div>
        </div>
    </header>

    <!-- Modals -->
    <div id="adminLoginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold text-gray-900">Yönetici Girişi</h3><button id="closeLoginModal" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div>
            <form id="adminLoginForm" class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-900 mb-2">Şifre</label><input type="password" id="adminPassword" class="w-full px-4 py-2 border-none rounded-lg" required></div>
                <button type="submit" class="w-full bg-turquoise-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-turquoise-700 shadow-md">Giriş Yap</button>
            </form>
        </div>
    </div>
    <div id="geminiAnalysisModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-2xl mx-4">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold text-gray-900">✨ Gemini Aylık Analizi</h3><button id="closeGeminiModal" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div>
            <div id="geminiAnalysisResult" class="p-4 bg-gray-50 rounded-lg max-h-96 overflow-y-auto"></div>
        </div>
    </div>
    <div id="routePlanModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-2xl mx-4">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold text-gray-900">✨ Gemini Akıllı Rota Planı</h3><button id="closeRoutePlanModal" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div>
            <div id="routePlanResult" class="p-4 bg-gray-50 rounded-lg max-h-96 overflow-y-auto"></div>
        </div>
    </div>
    <!-- Hızlı Kayıt Modalı Kaldırıldı -->
    <!-- Tekrarlayan Başvuru Modalı Kaldırıldı -->


    <!-- Navigation -->
    <nav class="glass-panel sticky top-[108px] z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-2 md:space-x-4 overflow-x-auto py-2">
                <button class="nav-link py-2 px-4 rounded-full text-gray-800 font-medium flex-shrink-0" data-tab="form">İhtiyaç Bildirimi</button>
                <button class="nav-link py-2 px-4 rounded-full text-gray-800 font-medium admin-only flex-shrink-0" data-tab="submissions">Başvurular</button>
                <button class="nav-link py-2 px-4 rounded-full text-gray-800 font-medium admin-only flex-shrink-0" data-tab="resources">Kaynaklar</button>
                <button class="nav-link py-2 px-4 rounded-full text-gray-800 font-medium admin-only flex-shrink-0" data-tab="reports">Raporlar</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Sections -->
        <div id="formSection" class="grid grid-cols-1 lg:grid-cols-3 gap-8"></div>
        <div id="submissionsSection" class="hidden admin-only"></div>
        <div id="resourcesSection" class="hidden admin-only"></div>
        <div id="reportsSection" class="hidden admin-only"></div>
    </main>

    <footer class="mt-12 text-center py-8">
        <p class="text-gray-800">© <span id="currentYear"></span> İstanbul Vali Koordinatörü Yardım Hattı</p>
    </footer>

    <script>
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        const ADMIN_PASSWORD = "2025Bjk2025.,."; // Basit şifre sistemi
        const firebaseConfig = {
            apiKey: "AIzaSyC0qeYrGc7fux8Ym4eEilnG7HMuOWsRigk",
            authDomain: "atasehir-roman-koordinatoru.firebaseapp.com",
            databaseURL: "https://atasehir-roman-koordinatoru-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "atasehir-roman-koordinatoru",
            storageBucket: "atasehir-roman-koordinatoru.appspot.com",
            messagingSenderId: "1090340718017",
            appId: "1:1090340718017:web:52980a10227508eec5db40"
        };

        let database = null, auth = null, submissions = [], resources = {};
        let currentCalendarDate = new Date();
        let isAdminLoggedIn = false; 

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth(); // Gemini için Auth'u tutuyoruz
        } catch (error) { console.error("Firebase initialization error:", error); }
        
        const anadoluYakasiIlceleri = ["Adalar", "Ataşehir", "Beykoz", "Çekmeköy", "Kadıköy", "Kartal", "Maltepe", "Pendik", "Sancaktepe", "Sultanbeyli", "Şile", "Tuzla", "Ümraniye", "Üsküdar"];
        const statusMap = { new: 'Yeni Başvuru', inProgress: 'İnceleniyor', appointment: 'Randevu Verildi', completed: 'Yardım Ulaştırıldı', cancelled: 'İptal Edildi' };
        const statusColors = { new: 'status-new', inProgress: 'status-inProgress', appointment: 'status-appointment', completed: 'status-completed', cancelled: 'status-cancelled' };
        
        document.addEventListener('DOMContentLoaded', () => {
            renderInitialHTML();
            addEventListeners();
            if (database) { loadAllData(); }
            navigateToTab('form'); // Başlangıçta formu göster
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.classList.add('dark-mode');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun text-yellow-400"></i>';
            } else {
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon text-gray-800"></i>';
            }
        });

        function renderInitialHTML() {
            document.getElementById('formSection').innerHTML = `<div class="lg:col-span-2"><div class="glass-panel rounded-2xl p-6"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-semibold text-gray-900 flex items-center"><i class="fas fa-user text-turquoise-600 mr-2"></i>İhtiyaç Bildirim Formu</h2></div><form id="needsForm" class="space-y-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-semibold text-gray-900 mb-2">Ad Soyad *</label><input type="text" id="name" class="w-full px-4 py-2 border-none rounded-lg" required></div><div><label class="block text-sm font-semibold text-gray-900 mb-2">Telefon *</label><input type="tel" id="phone" class="w-full px-4 py-2 border-none rounded-lg" required></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-semibold text-gray-900 mb-2">Adres</label><input type="text" id="address" class="w-full px-4 py-2 border-none rounded-lg"></div><div><label class="block text-sm font-semibold text-gray-900 mb-2">İlçe</label><select id="district" class="w-full px-4 py-2 border-none rounded-lg"><option value="">İlçe Seçin</option></select></div></div><div><label class="block text-sm font-semibold text-gray-900 mb-3">İhtiyaç Türleri *</label><div class="grid grid-cols-2 md:grid-cols-3 gap-3">${['food:Gıda:red:utensils','health:Sağlık:green:heartbeat','education:Eğitim:blue:graduation-cap','housing:Barınma:purple:home','employment:İstihdam:yellow:briefcase','legal:Hukuk:indigo:balance-scale','marketCard:Market Kartı:pink:shopping-cart','wheelchair:Tekerlekli Sandalye:gray:wheelchair','other:Diğer:gray:building'].map(n=>{const [v,t,c,i]=n.split(':');return `<label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" name="needs" value="${v}" class="h-4 w-4 rounded border-gray-300 text-turquoise-600 focus:ring-turquoise-500"><div class="flex items-center space-x-2 px-3 py-2 rounded-lg bg-${c}-100 text-${c}-800 font-medium"><i class="fas fa-${i} text-sm"></i><span>${t}</span></div></label>`}).join('')}</div></div><div id="otherNeedContainer" class="hidden"><label class="block text-sm font-semibold text-gray-900 mb-2">Diğer İhtiyaç</label><input type="text" id="otherNeed" class="w-full px-4 py-2 border-none rounded-lg"></div><div><label class="block text-sm font-semibold text-gray-900 mb-3">Aciliyet Durumu</label><div class="flex space-x-3">${['normal:Normal:green','high:Yüksek:yellow','urgent:Acil:red'].map(u=>{const [v,t,c]=u.split(':');return `<label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="urgency" value="${v}" class="text-turquoise-600" ${v==='normal'?'checked':''}><span class="px-3 py-1 rounded-full text-xs font-medium bg-${c}-100 text-${c}-800">${t}</span></label>`}).join('')}</div></div><div><label class="block text-sm font-semibold text-gray-900 mb-2">Detaylı Açıklama</label><textarea id="description" rows="4" class="w-full px-4 py-2 border-none rounded-lg"></textarea></div><button type="submit" class="w-full bg-turquoise-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-turquoise-700 shadow-lg">İhtiyacı Bildir</button></form></div></div>`;
            document.getElementById('submissionsSection').innerHTML = `<div class="glass-panel rounded-2xl p-6"><div class="flex flex-wrap items-center justify-between gap-4 mb-6"><div id="submissionsHeader"><h2 class="text-xl font-semibold text-gray-900 flex items-center"><i class="fas fa-file-alt text-turquoise-600 mr-2"></i>Başvurular</h2></div><div class="flex items-center space-x-2"><span class="text-sm text-gray-800">Toplam: <span id="submissionsCount" class="font-bold">0</span></span><button id="generateRouteBtn" class="p-2 rounded-full glass-panel text-blue-600" title="Akıllı Rota Planı Oluştur"><i class="fas fa-route"></i></button><button id="exportBtn" class="p-2 rounded-full glass-panel text-green-600" title="Tüm Verileri İndir (.CSV)"><i class="fas fa-file-excel"></i></button><button id="clearDataBtn" class="p-2 rounded-full glass-panel text-red-600" title="Tüm Verileri Sil"><i class="fas fa-trash-alt"></i></button><button id="refreshSubmissions" class="p-2 rounded-full glass-panel"><i class="fas fa-sync-alt text-gray-800"></i></button></div></div><div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"><div class="md:col-span-2 relative"><input type="text" id="searchInput" placeholder="İsim veya telefona göre ara..." class="w-full pl-10 pr-4 py-2 border-none rounded-lg"><i class="fas fa-search absolute top-3 left-3 text-gray-400"></i></div><select id="filterDistrict" class="w-full px-4 py-2 border-none rounded-lg"><option value="all">Tüm İlçeler</option></select><select id="filterStatus" class="w-full px-4 py-2 border-none rounded-lg"><option value="all">Tüm Durumlar</option></select><select id="filterUrgency" class="w-full px-4 py-2 border-none rounded-lg"><option value="all">Tüm Aciliyetler</option><option value="urgent">Acil</option><option value="high">Yüksek</option><option value="normal">Normal</option></select></div><div id="submissionsList" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div><div id="noSubmissions" class="text-center py-8 text-gray-500"><i class="fas fa-inbox text-4xl mb-4"></i><p>Henüz hiçbir başvuru bulunmamaktadır.</p></div></div>`;
            document.getElementById('resourcesSection').innerHTML = `<div class="glass-panel rounded-2xl p-6"><h2 class="text-xl font-semibold text-gray-900 mb-2 flex items-center"><i class="fas fa-cubes text-turquoise-600 mr-2"></i>Kaynaklar</h2><p class="text-sm text-gray-800 mb-6">Bir başvurunun durumu <strong class="text-gray-900">'Yardım Ulaştırıldı'</strong> olarak değiştirildiğinde, işlem notlarına <code class="bg-gray-200 dark:bg-gray-700 text-sm p-1 rounded">2 adet Gıda Kolisi</code> gibi yazılan ürünler stoktan otomatik düşülür.</p><div class="space-y-4" id="resourcesList"></div><div class="mt-6"><h3 class="text-lg font-semibold text-gray-900 mb-2">Yeni Kaynak Ekle</h3><div class="flex items-center space-x-2"><input type="text" id="newResourceName" placeholder="Yeni Kaynak Adı (Örn: Bebek Bezi)" class="w-full px-4 py-2 border-none rounded-lg"><input type="number" id="newResourceMinStock" placeholder="Min. Stok" class="w-24 px-4 py-2 border-none rounded-lg"><button id="addResourceBtn" class="bg-turquoise-600 text-white px-5 py-2 rounded-lg font-semibold shadow-md"><i class="fas fa-plus"></i></button></div></div><div class="mt-6"><h3 class="text-lg font-semibold text-gray-900 mb-2">Tehlikeli Alan</h3><button id="resetStocksBtn" class="w-full bg-red-600 text-white py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-red-700"><i class="fas fa-exclamation-triangle mr-2"></i>Tüm Stokları Sıfırla</button></div></div>`;
            document.getElementById('reportsSection').innerHTML = `<div class="glass-panel rounded-2xl p-6"><h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center"><i class="fas fa-calendar-alt text-turquoise-600 mr-2"></i>Raporlar</h2><div class="border-b border-gray-200 mb-4"><nav class="-mb-px flex space-x-8" aria-label="Tabs"><button id="tab-daterange" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-turquoise-500 text-turquoise-600">Tarih Aralığı</button><button id="tab-calendar" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Aylık Takvim</button><button id="tab-neighborhood" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">İlçe Analizi</button></nav></div><div id="daterange-report-content"></div><div id="calendar-report-content" class="hidden"></div><div id="neighborhood-report-content" class="hidden"></div></div>`;
            populateDistrictDropdown();
            populateStatusFilterDropdown();
            populateIlceFilterDropdown();
        }

        function addEventListeners() {
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('adminLoginBtn').addEventListener('click', () => document.getElementById('adminLoginModal').classList.remove('hidden'));
            document.getElementById('closeLoginModal').addEventListener('click', () => document.getElementById('adminLoginModal').classList.add('hidden'));
            document.getElementById('adminLoginForm').addEventListener('submit', handleAdminLogin);
            document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', handleNavigation));
            document.getElementById('needsForm').addEventListener('submit', handleFormSubmit);
            document.querySelector('input[value="other"]').addEventListener('change', (e) => document.getElementById('otherNeedContainer').classList.toggle('hidden', !e.target.checked));
            document.getElementById('refreshSubmissions').addEventListener('click', loadAllData);
            ['searchInput', 'filterStatus', 'filterUrgency', 'filterDistrict'].forEach(id => document.getElementById(id).addEventListener('input', loadSubmissionsList));
            document.getElementById('exportBtn').addEventListener('click', () => exportToCSV(submissions, 'tum_basvurular'));
            document.getElementById('clearDataBtn').addEventListener('click', confirmClearAllData);
            document.getElementById('addResourceBtn').addEventListener('click', addNewResource);
            document.getElementById('resetStocksBtn').addEventListener('click', confirmResetStocks);
            document.getElementById('closeSmsModal').addEventListener('click', () => document.getElementById('smsModal').classList.add('hidden'));
            document.getElementById('copySmsBtn').addEventListener('click', copySmsContent);
            document.getElementById('closeGeminiModal').addEventListener('click', () => document.getElementById('geminiAnalysisModal').classList.add('hidden'));
            document.getElementById('generateRouteBtn').addEventListener('click', generateRoutePlan);
            document.getElementById('closeRoutePlanModal').addEventListener('click', () => document.getElementById('routePlanModal').classList.add('hidden'));
            // Hızlı Kayıt ve Tekrarlayan Başvuru ile ilgili dinleyiciler kaldırıldı
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('themeToggle').innerHTML = isDark ? '<i class="fas fa-sun text-yellow-400"></i>' : '<i class="fas fa-moon text-gray-800"></i>';
        }

        function handleAdminLogin(e) { 
            e.preventDefault(); 
            if (document.getElementById('adminPassword').value === ADMIN_PASSWORD) { 
                isAdminLoggedIn = true;
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('admin-visible'));
                document.getElementById('adminLoginModal').classList.add('hidden'); 
                document.getElementById('adminPassword').value = ''; 
                const adminBtn = document.getElementById('adminLoginBtn'); 
                adminBtn.innerHTML = '<i class="fas fa-sign-out-alt text-red-600"></i>'; 
                adminBtn.title = 'Çıkış Yap'; 
                adminBtn.onclick = logoutAdmin; 
                loadAllData(); 
                navigateToTab('submissions'); 
            } else { 
                alert('Geçersiz şifre!'); 
            } 
        }
        function logoutAdmin() { 
            isAdminLoggedIn = false;
            document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('admin-visible')); 
            const adminBtn = document.getElementById('adminLoginBtn'); 
            adminBtn.innerHTML = '<i class="fas fa-lock text-turquoise-600"></i>'; 
            adminBtn.title = 'Yönetici Girişi'; 
            adminBtn.onclick = () => document.getElementById('adminLoginModal').classList.remove('hidden'); 
            navigateToTab('form'); 
        }
        function handleNavigation(e) { navigateToTab(e.target.dataset.tab); }
        function navigateToTab(tabId) { 
            if (!isAdminLoggedIn && tabId !== 'form') {
                document.getElementById('adminLoginModal').classList.remove('hidden');
                return;
            }
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); 
            const activeLink = document.querySelector(`.nav-link[data-tab="${tabId}"]`); 
            if(activeLink) activeLink.classList.add('active'); 
            document.querySelectorAll('main > div[id$="Section"]').forEach(el => el.classList.add('hidden')); 
            const activeSection = document.getElementById(tabId + 'Section'); 
            if(activeSection) activeSection.classList.remove('hidden'); 
            if(tabId === 'reports') initializeReportsTab();
        }

        async function loadAllData() { if (!database) return; await Promise.all([loadSubmissionsFromFirebase(), loadResourcesFromFirebase()]); updateAllViews(); }
        async function loadSubmissionsFromFirebase() { try { const snapshot = await database.ref('submissions').once('value'); const data = snapshot.val(); submissions = data ? Object.keys(data).map(key => ({ ...data[key], firebaseId: key })) : []; } catch(error) { console.error("Error loading submissions:", error); } }
        async function loadResourcesFromFirebase() { try { const snapshot = await database.ref('resources').once('value'); resources = snapshot.val() || {}; } catch(error) { console.error("Error loading resources:", error); } }
        
        async function saveSubmissionToFirebase(submission) { 
            if (!database) return; 
            try { 
                // Güvenli 'push' metodunu kullan
                await database.ref('submissions').push(submission); 
                document.getElementById('successMessageText').textContent = `Başvurunuz ${submission.submissionId} numarasıyla kaydedildi!`; 
                document.getElementById('successMessage').classList.remove('hidden'); 
                setTimeout(() => document.getElementById('successMessage').classList.add('hidden'), 5000); 
                await loadAllData(); 
            } catch (error) { console.error("Error saving submission:", error); } 
        }
        
        async function updateSubmissionField(firebaseId, field, value) { if (!database || !firebaseId) return; try { const subIndex = submissions.findIndex(s => s.firebaseId === firebaseId); if (subIndex > -1) { const oldStatus = submissions[subIndex].status; await database.ref(`submissions/${firebaseId}/${field}`).set(value); submissions[subIndex][field] = value; if(field === 'status') { submissions[subIndex].lastModified = new Date().toISOString(); await database.ref(`submissions/${firebaseId}/lastModified`).set(submissions[subIndex].lastModified); if (value === 'completed' && oldStatus !== 'completed') { const notes = submissions[subIndex].notes; if (notes) { await parseNotesAndDecreaseStock(notes); } } } } updateAllViews(); } catch (error) { console.error(`Error updating field "${field}":`, error); } }
        
        async function updateResource(name, field, value) { 
            if (!database) return; 
            try { 
                const numValue = Number(value);
                if (resources[name]) resources[name][field] = numValue; // 1. Yerel veriyi anında güncelle
                renderResources(); // 2. Arayüzü yerel veriye göre anında yenile
                await database.ref(`resources/${name}/${field}`).set(numValue); // 3. Arka planda Firebase'i güncelle
            } catch (error) { 
                console.error("Error updating resource:", error); 
                alert("Stok güncellenirken bir hata oluştu. Sayfayı yenileyin.");
            } 
        }
        
        async function addNewResource() { const name = document.getElementById('newResourceName').value.trim(); const minStock = document.getElementById('newResourceMinStock').value.trim(); if (name && !resources.hasOwnProperty(name)) { const newResourceData = { quantity: 0, minStock: Number(minStock) || 0 }; await database.ref(`resources/${name}`).set(newResourceData); resources[name] = newResourceData; document.getElementById('newResourceName').value = ''; document.getElementById('newResourceMinStock').value = ''; renderResources(); } else if (resources.hasOwnProperty(name)) { alert("Bu kaynak zaten mevcut."); } }

        function updateAllViews() { loadSubmissionsList(); renderResources(); }
        
        function renderResources() { 
            const list = document.getElementById('resourcesList'); 
            list.innerHTML = ''; 
            if(Object.keys(resources).length === 0) { 
                list.innerHTML = `<p class="text-gray-500">Henüz kaynak eklenmemiş.</p>`; 
                return; 
            }
            
            let resourcesHTML = '';
            const sortedResources = Object.entries(resources).sort((a, b) => a[0].localeCompare(b[0]));

            for (const [name, data] of sortedResources) { 
                const isLow = (data.quantity || 0) <= (data.minStock || 0); 
                resourcesHTML += `<div class="flex items-center justify-between p-3 glass-panel rounded-lg ${isLow ? 'border-2 border-red-500' : ''}">
                                    <span class="font-semibold text-gray-800">${name} ${isLow ? `<i class="fas fa-exclamation-triangle text-red-500 ml-2" title="Stok kritik seviyede!"></i>` : ''}</span>
                                    <div class="flex items-center space-x-2">
                                        <label class="text-xs text-gray-700">Min:</label>
                                        <input type="number" value="${data.minStock || 0}" onchange="updateResource('${name}', 'minStock', this.value)" class="w-16 text-center p-1 border-none rounded-md">
                                        <label class="text-xs text-gray-700">Stok:</label>
                                        <input type="number" value="${data.quantity || 0}" onchange="updateResource('${name}', 'quantity', this.value)" class="w-16 text-center p-1 border-none rounded-md">
                                    </div>
                                   </div>`; 
            }
            
            list.innerHTML = resourcesHTML;
        }
        
        function handleFormSubmit(e) { e.preventDefault(); const name = document.getElementById('name').value.trim(); const phone = document.getElementById('phone').value.trim(); if (!name || !phone) { document.getElementById('errorMessage').classList.remove('hidden'); setTimeout(() => document.getElementById('errorMessage').classList.add('hidden'), 3000); return; } const needsCheckboxes = document.querySelectorAll('input[name="needs"]:checked'); const needs = {}; needsCheckboxes.forEach(checkbox => { needs[checkbox.value] = true; }); const today = new Date(); const datePart = today.toISOString().slice(0, 10).replace(/-/g, ''); const timePart = today.getTime().toString().slice(-5); const newSubmission = { submissionId: `${datePart}-${timePart}`, name, phone, address: document.getElementById('address').value.trim(), district: document.getElementById('district').value, needs, otherNeed: needs.other ? document.getElementById('otherNeed').value.trim() : '', urgency: document.querySelector('input[name="urgency"]:checked').value, description: document.getElementById('description').value.trim(), timestamp: today.toISOString(), status: 'new', notes: '', submittedBy: "admin" }; saveSubmissionToFirebase(newSubmission); document.getElementById('needsForm').reset(); document.getElementById('otherNeedContainer').classList.add('hidden'); }
        
        async function generateActionPlan(firebaseId, type) {
            const sub = submissions.find(s => s.firebaseId === firebaseId);
            if (!sub) return;
            const buttonId = type === 'plan' ? `ai-btn-${firebaseId}` : `ai-summary-btn-${firebaseId}`;
            const button = document.getElementById(buttonId);
            const originalHtml = button.innerHTML;
            button.disabled = true;
            button.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            let systemPrompt, userQuery, container;
            if (type === 'plan') {
                container = document.getElementById(`ai-plan-${firebaseId}`);
                const needsList = sub.needs ? Object.keys(sub.needs).map(need => ({food:'Gıda',health:'Sağlık',education:'Eğitim',housing:'Barınma',employment:'İstihdam',legal:'Hukuk',marketCard:'Market Kartı',wheelchair:'Tekerlekli Sandalye',other:'Diğer'}[need])).join(', ') : 'Belirtilmemiş';
            
            const systemPrompt = "Sen Ataşehir'deki Roman vatandaşlara yardım eden bir koordinatörsün. Sana verilen başvuru bilgilerine göre, yapılması gerekenleri özetleyen 3 adımlık pratik bir eylem planı oluştur. Cevabın kısa, net ve sadece numaralandırılmış 3 maddeden oluşsun.";
            const userQuery = `Başvuru Bilgileri:\n- İhtiyaçlar: ${needsList}\n- Aciliyet: ${sub.urgency}\n- Açıklama: ${sub.description || 'Yok'}\n\nBu başvuru için 3 adımlık eylem planı nedir?`;
                container = document.getElementById(`notes-${firebaseId}`);
                systemPrompt = "Sana verilecek olan bir yardım başvurusuyla ilgili işlem notlarını tek bir paragrafta, yapılan temel eylemleri vurgulayarak özetle.";
                userQuery = `Aşağıdaki notları özetle:\n\n${container.value}`;
            }
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    if(type === 'plan') {
                        container.innerHTML = text.replace(/\n/g, '<br>');
                        container.classList.remove('hidden');
                        button.classList.add('hidden');
                    } else {
                        container.value = text;
                        alert('Notlar özetlendi!');
                    }
                } else { throw new Error('No content returned from API'); }
            } catch (error) {
                console.error("Gemini API error:", error);
                if(type === 'plan') container.innerHTML = 'Bir hata oluştu.';
                alert('Bir hata oluştu. Lütfen tekrar deneyin.');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        }
        async function generateRoutePlan() {
            const modalResult = document.getElementById('routePlanResult');
            modalResult.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Rota oluşturuluyor, lütfen bekleyin...';
            document.getElementById('routePlanModal').classList.remove('hidden');
            const relevantSubmissions = submissions.filter(s => (s.status === 'new' || s.status === 'inProgress') && (s.urgency === 'urgent' || s.urgency === 'high') && s.address);
            if (relevantSubmissions.length === 0) {
                modalResult.innerHTML = 'Rota oluşturmak için uygun (Acil veya Yüksek öncelikli) başvuru bulunmuyor.';
                return;
            }
            const addressList = relevantSubmissions.map(s => `- ${s.name}: ${s.address}, ${s.district}`).join('\n');
            
            const systemPrompt = "Sen bir lojistik koordinatörüsün. Sana verilen adres listesini İstanbul Anadolu Yakası içinde en verimli şekilde ziyaret edilecek bir rota haline getir. Adresleri ilçelerine göre gruplandır ve mantıklı bir ziyaret sırası öner. Cevabını net başlıklar ve listeler halinde sun.";
            const userQuery = `Aşağıdaki adres listesi için en verimli günlük ziyaret rotasını oluştur:\n\n${addressList}`;
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                modalResult.innerHTML = text ? text.replace(/\n/g, '<br>') : 'Rota planı oluşturulamadı.';
            } catch (error) {
                console.error("Gemini API error:", error);
                modalResult.innerHTML = 'Rota planı oluşturulurken bir hata oluştu.';
            }
        }
        
        function printSubmission(firebaseId) { const sub = submissions.find(s => s.firebaseId === firebaseId); if (!sub) return; const needsList = sub.needs ? Object.keys(sub.needs).map(need => ({food:'Gıda',health:'Sağlık',education:'Eğitim',housing:'Barınma',employment:'İstihdam',legal:'Hukuk',marketCard:'Market Kartı',wheelchair:'Tekerlekli Sandalye',other:'Diğer'}[need])).join(', ') : 'Belirtilmemiş'; const printWindow = window.open('', '_blank'); printWindow.document.write(`<html><head><title>Başvuru Çıktısı - ${sub.name}</title><style>body{font-family:sans-serif; margin: 20px;} h1{font-size:20px; border-bottom:1px solid #ccc; padding-bottom:10px;} .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px;} p{margin:5px 0;} strong{display:inline-block; width:120px;}</style></head><body><h1>Başvuru Detayları (#${sub.submissionId})</h1><div class="grid"><p><strong>Ad Soyad:</strong> ${sub.name}</p><p><strong>Telefon:</strong> ${sub.phone}</p><p><strong>Adres:</strong> ${sub.address}</p><p><strong>İlçe:</strong> ${sub.district}</p></div><h2>İhtiyaçlar</h2><p>${needsList}</p>${sub.otherNeed ? `<p><strong>Diğer İhtiyaç:</strong> ${sub.otherNeed}</p>` : ''}<h2>Açıklama</h2><p>${sub.description || 'Yok'}</p><h2>İşlem Notları</h2><p>${sub.notes || 'Yok'}</p><hr><p><strong>Tarih:</strong> ${new Date(sub.timestamp).toLocaleString('tr-TR')}</p><p><strong>Durum:</strong> ${statusMap[sub.status]}</p><p><strong>Aciliyet:</strong> ${sub.urgency}</p></body></html>`); printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); }, 500); }
        function confirmClearAllData() { if (confirm('Tüm verileri silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!')) { if (confirm('Son kez onaylıyor musunuz? Tüm başvuru kayıtları kalıcı olarak silinecek!')) { clearAllData(); } } }
        async function clearAllData() { if (!database) return; try { await database.ref('submissions').set(null); await database.ref('resources').set(null); submissions = []; resources = {}; updateAllViews(); alert('Tüm veriler başarıyla silindi!'); } catch (error) { console.error("Veri temizlenirken hata:", error); } }
        
        function confirmResetStocks() {
            if (confirm('Tüm kaynak stoklarını sıfırlamak istediğinizden emin misiniz? Bu işlem geri alınamaz!')) {
                resetAllStocks();
            }
        }
        
        async function resetAllStocks() {
            if (!database) return;
            try {
                for (const resourceName in resources) {
                    if (resources.hasOwnProperty(resourceName)) {
                        resources[resourceName].quantity = 0;
                        await database.ref(`resources/${resourceName}/quantity`).set(0);
                    }
                }
                renderResources();
                alert('Tüm kaynak stokları başarıyla sıfırlandı.');
            } catch (error) {
                console.error("Stok sıfırlanırken hata:", error);
                alert('Stoklar sıfırlanırken bir hata oluştu.');
            }
        }

        function exportToCSV(dataToExport, filenamePrefix) {
             if (!dataToExport || dataToExport.length === 0) return;
             const headers = ['Başvuru No','Durum','Ad Soyad','Telefon','Adres','İlçe','Gıda','Sağlık','Eğitim','Barınma','İstihdam','Hukuk','Market Kartı','Tekerlekli Sandalye','Diğer','Diğer İhtiyaç','Aciliyet','Açıklama','Notlar','Tarih'];
             const csvContent = [ headers.join(','), ...dataToExport.map(sub => { const needs = sub.needs || {}; return [`"${sub.submissionId || ''}"`,`"${statusMap[sub.status] || 'Bilinmiyor'}"`,`"${sub.name || ''}"`,`"${sub.phone || ''}"`,`"${sub.address || ''}"`,`"${sub.district || ''}"`,needs.food?'Evet':'Hayır',needs.health?'Evet':'Hayır',needs.education?'Evet':'Hayır',needs.housing?'Evet':'Hayır',needs.employment?'Evet':'Hayır',needs.legal?'Evet':'Hayır',needs.marketCard?'Evet':'Hayır',needs.wheelchair?'Evet':'Hayır',needs.other?'Evet':'Hayır',`"${sub.otherNeed||''}"`,sub.urgency==='urgent'?'Acil':sub.urgency==='high'?'Yüksek':'Normal',`"${(sub.description||'').replace(/"/g,'""')}"`,`"${(sub.notes||'').replace(/"/g,'""')}"`,`"${new Date(sub.timestamp).toLocaleString('tr-TR')}"`].join(','); })].join('\n'); const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.setAttribute('href', url); link.setAttribute('download', `${filenamePrefix}_${new Date().toISOString().split('T')[0]}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); }

        function populateDistrictDropdown() { const select = document.getElementById('district'); if(!select) return; anadoluYakasiIlceleri.sort().forEach(d => { select.innerHTML += `<option value="${d}">${d}</option>`; }); }
        function populateStatusFilterDropdown() { const statusFilter = document.getElementById('filterStatus'); if(!statusFilter) return; for (const [key, value] of Object.entries(statusMap)) { const option = document.createElement('option'); option.value = key; option.textContent = value; statusFilter.appendChild(option); } }
        function populateIlceFilterDropdown() { const filterSelect = document.getElementById('filterDistrict'); if(!filterSelect) return; anadoluYakasiIlceleri.sort().forEach(d => { filterSelect.innerHTML += `<option value="${d}">${d}</option>`; }); }
        
        function showApplicantHistory(phone, name) {
            const header = document.getElementById('submissionsHeader');
            header.innerHTML = `
                <div class="flex items-center space-x-4">
                    <div>
                         <h2 class="text-xl font-semibold text-gray-900">${name} Geçmişi</h2>
                         <p class="text-sm text-gray-700">${phone}</p>
                    </div>
                    <button id="backToAllBtn" class="py-1 px-3 rounded-full text-sm text-gray-800 font-medium glass-panel">Tümüne Dön</button>
                </div>`;
            document.getElementById('backToAllBtn').addEventListener('click', () => {
                header.innerHTML = `<h2 class="text-xl font-semibold text-gray-900 flex items-center"><i class="fas fa-file-alt text-turquoise-600 mr-2"></i>Başvurular</h2>`;
                document.getElementById('searchInput').value = '';
                loadSubmissionsList();
            });
            document.getElementById('searchInput').value = phone;
            loadSubmissionsList();
        }
        
        function openSmsModal(firebaseId) {
            const sub = submissions.find(s => s.firebaseId === firebaseId);
            if (!sub) return;
            const templatesContainer = document.getElementById('smsTemplates');
            templatesContainer.innerHTML = '';
            const smsTemplates = {
                received: `Sayın ${sub.name}, #${sub.submissionId} numaralı başvurunuz İstanbul Valiliği Koordinatörlüğü'ne ulaşmıştır. En kısa sürede sizinle iletişime geçilecektir.`,
                appointment: `Sayın ${sub.name}, #${sub.submissionId} numaralı başvurunuz hakkında görüşmek üzere sizinle bir randevu planlamak istiyoruz. Lütfen geri dönüş yapınız.`,
                onway: `Sayın ${sub.name}, #${sub.submissionId} numaralı başvurunuz ile ilgili ekibimiz adresinize doğru yola çıkmıştır. Bilginize.`
            };
            Object.keys(smsTemplates).forEach(key => {
                const button = document.createElement('button');
                button.className = 'w-full text-left text-sm bg-gray-100 dark:bg-gray-700 p-2 rounded-lg hover:bg-gray-200';
                button.textContent = {received: 'Başvuru Alındı', appointment: 'Randevu Talebi', onway: 'Ekip Yolda'}[key];
                button.onclick = () => generateSmsMessage(smsTemplates[key]);
                templatesContainer.appendChild(button);
            });
            document.getElementById('smsContent').value = '';
            document.getElementById('smsModal').classList.remove('hidden');
        }

        function generateSmsMessage(message) { document.getElementById('smsContent').value = message; }
        function copySmsContent() { const content = document.getElementById('smsContent'); content.select(); document.execCommand('copy'); alert('Mesaj panoya kopyalandı!'); }

        function loadSubmissionsList() { const listContainer = document.getElementById('submissionsList'); if(!listContainer) return; listContainer.innerHTML = ''; const searchTerm = document.getElementById('searchInput').value.toLowerCase(); const statusFilter = document.getElementById('filterStatus').value; const urgencyFilter = document.getElementById('filterUrgency').value; const districtFilter = document.getElementById('filterDistrict').value; let filteredSubmissions = submissions.filter(sub => { const nameMatch = (sub.name || '').toLowerCase().includes(searchTerm); const phoneMatch = (sub.phone || '').includes(searchTerm); const statusMatch = statusFilter === 'all' || sub.status === statusFilter; const urgencyMatch = urgencyFilter === 'all' || sub.urgency === urgencyFilter; const districtMatch = (districtFilter === 'all' || sub.district === districtFilter); return (nameMatch || phoneMatch) && statusMatch && urgencyMatch && districtMatch; }); document.getElementById('noSubmissions').classList.toggle('hidden', filteredSubmissions.length > 0); document.getElementById('submissionsCount').textContent = filteredSubmissions.length; const sortedSubmissions = filteredSubmissions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); sortedSubmissions.forEach(sub => { const needsLabels = {food:'Gıda',health:'Sağlık',education:'Eğitim',housing:'Barınma',employment:'İstihdam',legal:'Hukuk',marketCard:'Market Kartı',wheelchair:'Tekerlekli Sandalye',other:'Diğer'}; const needsList = sub.needs ? Object.keys(sub.needs).map(need => needsLabels[need]).join(', ') : 'Belirtilmemiş'; let statusDropdownHTML = `<select onchange="updateSubmissionField('${sub.firebaseId}', 'status', this.value)" class="w-full p-1 border-none rounded-md text-sm">`; for (const [key, value] of Object.entries(statusMap)) { statusDropdownHTML += `<option value="${key}" ${sub.status === key ? 'selected' : ''}>${value}</option>`; } statusDropdownHTML += `</select>`; const el = document.createElement('div'); el.className = 'glass-panel rounded-xl p-4'; el.innerHTML = `<div class="flex justify-between items-center mb-3"><div class="flex-1"><h3 class="font-semibold text-gray-900">${sub.name}</h3><div class="flex items-center space-x-2"><p class="text-sm text-gray-800">${sub.phone}</p><button onclick="showApplicantHistory('${sub.phone}', '${sub.name}')" title="Kişi Geçmişi" class="text-xs text-turquoise-600"><i class="fas fa-history"></i></button><button onclick="openSmsModal('${sub.firebaseId}')" title="Hızlı SMS" class="text-xs text-turquoise-600"><i class="fas fa-comment-sms"></i></button></div><p class="text-xs text-gray-500 mt-1">#${sub.submissionId}</p></div><div class="flex items-center space-x-2"><span class="status-badge ${statusColors[sub.status]||'bg-gray-200'}">${statusMap[sub.status]||sub.status}</span><button onclick="printSubmission('${sub.firebaseId}')" class="p-2 rounded-full glass-panel text-gray-800" title="Yazdır"><i class="fas fa-print"></i></button></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3"><p class="text-sm text-gray-800 font-medium"><i class="fas fa-map-marker-alt mr-2 text-gray-400"></i>${sub.address||'...'}</p><p class="text-sm text-gray-800 font-medium"><i class="fas fa-city mr-2 text-gray-400"></i>${sub.district||'...'}</p><p class="text-sm text-gray-800 font-medium"><i class="fas fa-list mr-2 text-gray-400"></i>${needsList}</p>${sub.otherNeed?`<p class="text-sm text-gray-800 font-medium"><i class="fas fa-plus mr-2 text-gray-400"></i>${sub.otherNeed}</p>`:''}</div>${sub.description?`<p class="text-sm font-medium text-gray-900 glass-panel p-3 rounded-lg mb-3">${sub.description}</p>`:''}<div class="border-t border-gray-200 pt-3 mt-3 space-y-3"><div id="ai-plan-${sub.firebaseId}" class="hidden p-3 bg-blue-50 text-blue-800 rounded-lg text-sm"></div><button id="ai-btn-${sub.firebaseId}" onclick="generateActionPlan('${sub.firebaseId}', 'plan')" class="w-full text-sm bg-blue-100 text-blue-800 px-3 py-2 rounded-lg hover:bg-blue-200 font-semibold">✨ Eylem Planı Oluştur</button><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div class="md:col-span-2"><label class="block text-xs font-semibold text-gray-700 mb-1">İşlem Notları</label><div class="flex items-center space-x-2"><textarea id="notes-${sub.firebaseId}" class="w-full text-sm p-2 border-none rounded-md" rows="2">${sub.notes||''}</textarea><button id="ai-summary-btn-${sub.firebaseId}" onclick="generateActionPlan('${sub.firebaseId}', 'summary')" title="Notları Özetle" class="p-2 rounded-full glass-panel text-blue-600">✨</button></div><button onclick="updateSubmissionField('${sub.firebaseId}','notes',document.getElementById('notes-${sub.firebaseId}').value)" class="mt-1 text-xs bg-turquoise-100 text-turquoise-800 px-2 py-1 rounded hover:bg-turquoise-200">Notu Kaydet</button></div><div><label class="block text-xs font-semibold text-gray-700 mb-1">Durumu Değiştir</label>${statusDropdownHTML}</div></div></div><p class="text-xs text-gray-500 mt-3 text-right"><i class="fas fa-clock mr-1"></i>${new Date(sub.timestamp).toLocaleString('tr-TR')}</p>`; listContainer.appendChild(el); }); }
        
        async function parseNotesAndDecreaseStock(notesText) { if (!notesText) return; let updatesMade = false; let updateSummary = []; const currentResources = { ...resources }; for (const resourceName in currentResources) { const escapedResourceName = resourceName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); const regex = new RegExp(`(\\d+)\\s*(?:x|adet|paket|tane)?\\s*${escapedResourceName}|${escapedResourceName}\\s*x\\s*(\\d+)`, "i"); const match = notesText.match(regex); if (match) { const quantityToDecrease = parseInt(match[1] || match[2], 10); if (!isNaN(quantityToDecrease) && quantityToDecrease > 0) { const currentStock = currentResources[resourceName].quantity || 0; const newStock = currentStock - quantityToDecrease; await updateResource(resourceName, 'quantity', newStock); resources[resourceName].quantity = newStock; updateSummary.push(`${resourceName}: -${quantityToDecrease}`); updatesMade = true; } } } if (updatesMade) { renderResources(); alert("Stok güncellendi:\n" + updateSummary.join("\n")); } }
        
        function initializeReportsTab() {
            const daterangeContent = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 items-end"><div><label class="block text-sm font-medium text-gray-900 mb-2">Başlangıç</label><input type="date" id="reportDateStart" class="w-full px-4 py-2 border-none rounded-lg"></div><div><label class="block text-sm font-medium text-gray-900 mb-2">Bitiş</label><input type="date" id="reportDateEnd" class="w-full px-4 py-2 border-none rounded-lg"></div><button id="generateReportBtn" class="w-full bg-turquoise-600 text-white py-2 px-4 rounded-lg font-semibold shadow-md">Rapor Oluştur</button></div><div id="dailyReportContent" class="glass-panel rounded-xl p-6 hidden"><h3 class="text-lg font-semibold text-gray-900 mb-4">Rapor: <span id="reportDateDisplay"></span></h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"><div class="glass-panel p-4 rounded-lg"><h4 class="font-medium text-gray-800">Toplam Başvuru</h4><p id="reportTotal" class="text-2xl font-bold text-gray-900">0</p></div><div class="glass-panel p-4 rounded-lg"><h4 class="font-medium text-gray-800">Acil Durumlar</h4><p id="reportUrgent" class="text-2xl font-bold text-gray-900">0</p></div><div class="glass-panel p-4 rounded-lg"><h4 class="font-medium text-gray-800">En Çok İhtiyaç</h4><p id="reportTopNeed" class="text-lg font-medium text-gray-900">-</p></div></div><div class="mb-4"><h4 class="font-medium text-gray-900 mb-2">İhtiyaç Dağılımı</h4><div id="reportNeedsChart" class="space-y-2"></div></div><button id="exportReportBtn" class="bg-turquoise-600 text-white px-4 py-2 rounded-lg shadow-md"><i class="fas fa-download mr-2"></i>İndir</button></div><div id="noReportData" class="text-center py-8 text-gray-500"><i class="fas fa-file-alt text-4xl mb-4"></i><p>Tarih aralığı seçip "Rapor Oluştur" butonuna basın.</p></div>`;
            const calendarContent = `<div class="flex items-center justify-between mb-4"><button id="prevMonthBtn" class="p-2 rounded-full glass-panel"><i class="fas fa-chevron-left"></i></button><h3 id="monthYearDisplay" class="text-lg font-semibold text-gray-900"></h3><button id="nextMonthBtn" class="p-2 rounded-full glass-panel"><i class="fas fa-chevron-right"></i></button></div><div id="geminiAnalyzeContainer" class="my-4"></div><div class="grid grid-cols-7 gap-2 text-center font-semibold text-gray-700 mb-2"><div>Pzt</div><div>Sal</div><div>Çar</div><div>Per</div><div>Cum</div><div>Cmt</div><div>Paz</div></div><div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>`;
            const neighborhoodContent = `<div id="neighborhoodAnalysis" class="space-y-4"></div>`;
            document.getElementById('reportsSection').querySelector('#daterange-report-content').innerHTML = daterangeContent;
            document.getElementById('reportsSection').querySelector('#calendar-report-content').innerHTML = calendarContent;
            document.getElementById('reportsSection').querySelector('#neighborhood-report-content').innerHTML = neighborhoodContent;
            document.getElementById('generateReportBtn').addEventListener('click', generateReportByDateRange);
            document.getElementById('prevMonthBtn').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth()); });
            document.getElementById('nextMonthBtn').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth()); });
            document.getElementById('tab-daterange').addEventListener('click', switchReportTab);
            document.getElementById('tab-calendar').addEventListener('click', switchReportTab);
            document.getElementById('tab-neighborhood').addEventListener('click', switchReportTab);
            renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
        }

        function switchReportTab(e) {
            const tabs = ['tab-daterange', 'tab-calendar', 'tab-neighborhood'];
            const contents = ['daterange-report-content', 'calendar-report-content', 'neighborhood-report-content'];
            const selectedTab = e.target.id;
            
            tabs.forEach(tabId => {
                const tab = document.getElementById(tabId);
                const isSelected = tabId === selectedTab;
                tab.classList.toggle('border-turquoise-500', isSelected);
                tab.classList.toggle('text-turquoise-600', isSelected);
                tab.classList.toggle('border-transparent', !isSelected);
                tab.classList.toggle('text-gray-500', !isSelected);
            });

            contents.forEach(contentId => {
                document.getElementById(contentId).classList.toggle('hidden', contentId !== `${selectedTab.split('-')[1]}-report-content`);
            });

            if (selectedTab === 'tab-neighborhood') {
                renderNeighborhoodAnalysis();
            }
        }

        function renderCalendar(year, month) {
            const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
            document.getElementById('monthYearDisplay').textContent = `${monthNames[month]} ${year}`;
            const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dayOffset = (firstDay === 0) ? 6 : firstDay - 1;
            for (let i = 0; i < dayOffset; i++) { grid.innerHTML += '<div></div>'; }
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toISOString().split('T')[0];
                const daySubmissions = submissions.filter(s => s.timestamp.startsWith(dateString));
                const count = daySubmissions.length;
                let cellClass = 'glass-panel p-2 rounded-lg text-left h-24 flex flex-col justify-between';
                if(count > 0) cellClass += ' bg-turquoise-100/50 dark:bg-turquoise-900/50';
                grid.innerHTML += `<div class="${cellClass}"><span class="font-bold text-gray-900">${day}</span>${count > 0 ? `<span class="text-xs text-turquoise-700 font-semibold">${count} başvuru</span>` : ''}</div>`;
            }
            const analyzeContainer = document.getElementById('geminiAnalyzeContainer');
            analyzeContainer.innerHTML = `<button onclick="analyzeMonthWithGemini(${year}, ${month})" class="w-full text-sm bg-blue-100 text-blue-800 px-3 py-2 rounded-lg hover:bg-blue-200 font-semibold">✨ ${monthNames[month]} Ayını Analiz Et</button>`;
        }
        
        function generateReportByDateRange() {
            let filteredSubmissions = [];
            const startDate = document.getElementById('reportDateStart').value;
            const endDate = document.getElementById('reportDateEnd').value;
            if (!startDate || !endDate) return;
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23,59,59,999);
            filteredSubmissions = submissions.filter(sub => { const subDate = new Date(sub.timestamp); return subDate >= start && subDate <= end; });
            const reportContent = document.getElementById('dailyReportContent');
            const noReportData = document.getElementById('noReportData');
            reportContent.classList.toggle('hidden', filteredSubmissions.length === 0);
            noReportData.classList.toggle('hidden', filteredSubmissions.length > 0);
            noReportData.textContent = filteredSubmissions.length===0?"Seçilen tarih aralığı için veri bulunmamaktadır.":'Lütfen bir tarih aralığı seçip "Rapor Oluştur" butonuna basın.';
            if (filteredSubmissions.length === 0) { document.getElementById('exportReportBtn').onclick = null; return; }
            const startStr = start.toLocaleDateString('tr-TR');
            const endStr = end.toLocaleDateString('tr-TR');
            document.getElementById('reportDateDisplay').textContent = `${startStr} - ${endStr}`;
            document.getElementById('reportTotal').textContent = filteredSubmissions.length;
            document.getElementById('reportUrgent').textContent = filteredSubmissions.filter(sub => sub.urgency === 'urgent').length;
            const needsCount = {food:0,health:0,education:0,housing:0,employment:0,legal:0,marketCard:0,wheelchair:0,other:0};
            filteredSubmissions.forEach(sub => { if(sub.needs) Object.keys(needsCount).forEach(need => { if (sub.needs[need]) needsCount[need]++; }); });
            const needsLabels = {food:'Gıda',health:'Sağlık',education:'Eğitim',housing:'Barınma',employment:'İstihdam',legal:'Hukuk',marketCard:'Market Kartı',wheelchair:'Tekerlekli Sandalye',other:'Diğer'};
            const topNeedEntry = Object.entries(needsCount).reduce((a, b) => b[1] - a[1] > 0 ? b : a, [null, 0]);
            document.getElementById('reportTopNeed').textContent = topNeedEntry[1] > 0 ? needsLabels[topNeedEntry[0]] : '-';
            const reportNeedsChart = document.getElementById('reportNeedsChart');
            reportNeedsChart.innerHTML = '';
            Object.entries(needsCount).forEach(([key, count]) => { if (count > 0) { const totalNeeds = Object.values(needsCount).reduce((a,b) => a + b, 0); const percentage = totalNeeds > 0 ? Math.round((count / totalNeeds) * 100) : 0; reportNeedsChart.innerHTML += `<div class="flex items-center justify-between"><span class="text-sm font-medium">${needsLabels[key]}</span><div class="flex items-center space-x-2"><div class="w-24 bg-gray-200 rounded-full h-2"><div class="bg-turquoise-600 h-2 rounded-full" style="width:${percentage}%"></div></div><span class="text-sm text-gray-600">${count}</span></div></div>`; } });
            
            document.getElementById('exportReportBtn').onclick = () => {
                exportToCSV(filteredSubmissions, `rapor_${startDate}_${endDate}`);
            };
        }

        function renderNeighborhoodAnalysis() {
            const container = document.getElementById('neighborhoodAnalysis');
            container.innerHTML = '';
            const needsLabels = {food:'Gıda',health:'Sağlık',education:'Eğitim',housing:'Barınma',employment:'İstihdam',legal:'Hukuk',marketCard:'Market Kartı',wheelchair:'Tekerlekli Sandalye',other:'Diğer'};
            
            const districtNeeds = submissions.reduce((acc, sub) => {
                if (sub.district) {
                    if (!acc[sub.district]) {
                        acc[sub.district] = { total: 0, needs: {} };
                    }
                    acc[sub.district].total++;
                    if (sub.needs) {
                        for (const need in sub.needs) {
                            if (sub.needs[need]) {
                                acc[sub.district].needs[need] = (acc[sub.district].needs[need] || 0) + 1;
                            }
                        }
                    }
                }
                return acc;
            }, {});

            const sortedDistricts = Object.entries(districtNeeds).sort((a, b) => b[1].total - a[1].total);

            if (sortedDistricts.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Analiz için yeterli ilçe verisi bulunmuyor.</p>';
                return;
            }

            sortedDistricts.forEach(([district, data]) => {
                const topNeeds = Object.entries(data.needs).sort((a,b) => b[1] - a[1]).slice(0, 3).map(([need, count]) => `${needsLabels[need]} (${count})`).join(', ');
                const el = document.createElement('div');
                el.className = 'glass-panel p-4 rounded-lg';
                el.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h4 class="font-semibold text-gray-900">${district}</h4>
                        <span class="font-bold text-turquoise-600">${data.total} Başvuru</span>
                    </div>
                    <p class="text-sm text-gray-700 mt-2"><strong>Yoğunlaşan İhtiyaçlar:</strong> ${topNeeds || 'Belirtilmemiş'}</p>
                `;
                container.appendChild(el);
            });
        }
        async function analyzeMonthWithGemini(year, month) {
            const modalResult = document.getElementById('geminiAnalysisResult');
            modalResult.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Analiz ediliyor, lütfen bekleyin...';
            document.getElementById('geminiAnalysisModal').classList.remove('hidden');

            const monthSubmissions = submissions.filter(s => {
                const date = new Date(s.timestamp);
                return date.getFullYear() === year && date.getMonth() === month;
            });

            if (monthSubmissions.length === 0) {
                modalResult.innerHTML = 'Bu ay için analiz edilecek veri bulunmuyor.';
                return;
            }

            const total = monthSubmissions.length;
            const urgent = monthSubmissions.filter(s => s.urgency === 'urgent').length;
            const needs = monthSubmissions.flatMap(s => s.needs ? Object.keys(s.needs) : []);
            const needsCount = needs.reduce((acc, need) => { acc[need] = (acc[need] || 0) + 1; return acc; }, {});
            const topNeeds = Object.entries(needsCount).sort((a,b) => b[1] - a[1]).slice(0,3).map(([need, count]) => `${({food:'Gıda',health:'Sağlık',education:'Eğitim',housing:'Barınma',employment:'İstihdam',legal:'Hukuk',marketCard:'Market Kartı',wheelchair:'Tekerlekli Sandalye',other:'Diğer'}[need] || need)} (${count})`).join(', ');

            const systemPrompt = "Sen İstanbul Anadolu Yakası'ndaki vatandaşlara yardım eden bir sosyal yardım uzmanısın. Sana verilen aylık verileri analiz ederek, gelecek ay için stratejik öneriler sunan kısa ve net bir yönetici özeti yaz. Önerilerin, kaynakların doğru yönlendirilmesi ve potansiyel sorunların öngörülmesi üzerine odaklanmalı.";
            const userQuery = `İşte ${new Date(year, month).toLocaleString('tr-TR', { month: 'long', year: 'numeric' })} ayı verileri:\n- Toplam Başvuru: ${total}\n- Acil Başvuru Sayısı: ${urgent}\n- En Çok Talep Edilen İhtiyaçlar: ${topNeeds}\n\nBu verilere dayanarak yönetici özetini ve stratejik önerilerini oluştur.`;
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                modalResult.innerHTML = text ? text.replace(/\n/g, '<br>') : 'Analiz oluşturulamadı.';
            } catch (error) {
                console.error("Gemini API error:", error);
                modalResult.innerHTML = 'Analiz sırasında bir hata oluştu.';
            }
        }
    </script>
</body>
</html>

