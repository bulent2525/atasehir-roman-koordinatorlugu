<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ataşehir Valilik Roman Koordinatörlüğü</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet.js for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'turquoise': {
                            50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 300: '#5eead4',
                            400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e',
                            800: '#115e59', 900: '#134e4a'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%); }
        .dark-mode { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #f8fafc; }
        .dark-mode .bg-white { background-color: #1e293b !important; color: #f8fafc; }
        .dark-mode .text-gray-900 { color: #f8fafc !important; }
        .dark-mode .text-gray-800 { color: #e5e7eb !important; }
        .dark-mode .text-gray-700 { color: #d1d5db !important; }
        .dark-mode .text-gray-600 { color: #94a3b8 !important; }
        .dark-mode .border-gray-200 { border-color: #374151 !important; }
        .dark-mode .border-gray-300 { border-color: #334155 !important; }
        .dark-mode input, .dark-mode textarea, .dark-mode select { background-color: #334155 !important; color: #f8fafc !important; border-color: #475569 !important; }
        .dark-mode .bg-gray-50 { background-color: #374151 !important; }
        .dark-mode .bg-gray-100 { background-color: #374151 !important; }
        .fixed-notification { position: fixed; top: 1rem; right: 1rem; z-index: 1050; }
        .nav-link { transition: all 0.3s ease; }
        .nav-link:hover { transform: translateY(-2px); }
        .nav-link.active { background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); color: white !important; }
        .admin-only { display: none; }
        .admin-visible { display: block !important; }
        .status-badge { padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; text-transform: capitalize; }
        .status-new { background-color: #e0f2fe; color: #0c4a6e; }
        .status-inProgress { background-color: #fef9c3; color: #713f12; }
        .status-appointment { background-color: #e0e7ff; color: #312e81; }
        .status-completed { background-color: #dcfce7; color: #15803d; }
        .status-cancelled { background-color: #fee2e2; color: #991b1b; }
        #map { height: 75vh; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); z-index: 1; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Firebase SDK (Uyumluluk Versiyonu) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-turquoise-600">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-turquoise-600 p-3 rounded-full">
                        <i class="fas fa-map-marker-alt text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Ataşehir Valilik Roman Koordinatörlüğü</h1>
                        <p class="text-gray-800 mt-1">Dezavantajlı Roman Halkı Destek Sistemi</p>
                    </div>
                </div>
                <div class="mt-4 md:mt-0 flex items-center space-x-4">
                    <div class="flex flex-col space-y-2">
                        <div class="flex items-center space-x-2 text-gray-800"><i class="fas fa-phone text-turquoise-600"></i><span class="font-medium">545 774 27 53</span></div>
                        <div class="flex items-center space-x-2 text-gray-800"><i class="fas fa-envelope text-turquoise-600"></i><span class="font-medium">atasehirvalikoordinatoru@gmail.com</span></div>
                    </div>
                    <button id="themeToggle" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors"><i class="fas fa-moon text-gray-600"></i></button>
                    <button id="adminLoginBtn" class="p-2 rounded-lg bg-turquoise-100 hover:bg-turquoise-200 transition-colors"><i class="fas fa-lock text-turquoise-600"></i></button>
                </div>
            </div>
        </div>
    </header>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Yönetici Girişi</h3>
                <button id="closeLoginModal" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <form id="adminLoginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-900 mb-2">Şifre</label>
                    <input type="password" id="adminPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-turquoise-500 focus:border-turquoise-500" placeholder="Yönetici şifresini girin" required/>
                </div>
                <button type="submit" class="w-full bg-turquoise-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-turquoise-700 focus:outline-none focus:ring-2 focus:ring-turquoise-500 focus:ring-offset-2 transition-colors duration-200">Giriş Yap</button>
            </form>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-md border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-8 overflow-x-auto">
                <button class="nav-link py-4 px-2 border-b-2 border-transparent text-gray-800 hover:border-turquoise-500 hover:text-turquoise-600 font-medium flex-shrink-0" data-tab="form">İhtiyaç Bildirimi</button>
                <button class="nav-link py-4 px-2 border-b-2 border-transparent text-gray-800 hover:border-turquoise-500 hover:text-turquoise-600 font-medium admin-only flex-shrink-0" data-tab="dashboard">Ana Panel</button>
                <button class="nav-link py-4 px-2 border-b-2 border-transparent text-gray-800 hover:border-turquoise-500 hover:text-turquoise-600 font-medium admin-only flex-shrink-0" data-tab="submissions">Başvurular</button>
                <button class="nav-link py-4 px-2 border-b-2 border-transparent text-gray-800 hover:border-turquoise-500 hover:text-turquoise-600 font-medium admin-only flex-shrink-0" data-tab="map">Harita</button>
                <button class="nav-link py-4 px-2 border-b-2 border-transparent text-gray-800 hover:border-turquoise-500 hover:text-turquoise-600 font-medium admin-only flex-shrink-0" data-tab="resources">Kaynaklar</button>
                <button class="nav-link py-4 px-2 border-b-2 border-transparent text-gray-800 hover:border-turquoise-500 hover:text-turquoise-600 font-medium admin-only flex-shrink-0" data-tab="reports">Raporlar</button>
                <button class="nav-link py-4 px-2 border-b-2 border-transparent text-gray-800 hover:border-turquoise-500 hover:text-turquoise-600 font-medium admin-only flex-shrink-0" data-tab="management">Veri Yönetimi</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Success/Error Messages -->
        <div id="successMessage" class="fixed-notification bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2 hidden">
            <i class="fas fa-check-circle"></i><span id="successMessageText">Başvurunuz başarıyla kaydedildi!</span>
        </div>
        <div id="errorMessage" class="fixed-notification bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2 hidden">
            <i class="fas fa-exclamation-circle"></i><span>Lütfen zorunlu alanları doldurun!</span>
        </div>

        <!-- Sections -->
        <div id="formSection" class="grid grid-cols-1 lg:grid-cols-3 gap-8"></div>
        <div id="dashboardSection" class="hidden admin-only"></div>
        <div id="submissionsSection" class="hidden admin-only"></div>
        <div id="mapSection" class="hidden admin-only">
            <div class="bg-white rounded-xl shadow-lg p-6">
                 <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center"><i class="fas fa-map-marked-alt text-turquoise-600 mr-2"></i>Başvuru Haritası</h2>
                 <p class="text-sm text-gray-700 mb-4">Başvurular adreslerine göre harita üzerinde gösterilmektedir. Kırmızı iğneler acil durumları belirtir.</p>
                 <div id="map"></div>
            </div>
        </div>
        <div id="resourcesSection" class="hidden admin-only"></div>
        <div id="reportsSection" class="hidden admin-only"></div>
        <div id="managementSection" class="hidden admin-only"></div>
    </main>

    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-gray-300">© <span id="currentYear"></span> Ataşehir Valilik Roman Koordinatörlüğü - Dezavantajlı Roman Halkı Destek Platformu</p>
            <p class="text-gray-400 mt-2 text-sm">Tüm hakları saklıdır.</p>
        </div>
    </footer>

    <script>
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        const ADMIN_PASSWORD = "2025Bjk2025.,.";
        const firebaseConfig = {
            apiKey: "AIzaSyC0qeYrGc7fux8Ym4eEilnG7HMuOWsRigk", authDomain: "atasehir-roman-koordinatoru.firebaseapp.com",
            databaseURL: "https://atasehir-roman-koordinatoru-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "atasehir-roman-koordinatoru", storageBucket: "atasehir-roman-koordinatoru.appspot.com",
            messagingSenderId: "1090340718017", appId: "1:1090340718017:web:52980a10227508eec5db40"
        };

        let database = null;
        let submissions = [];
        let resources = {};
        let reportSubmissions = [];
        let map = null;
        const markers = [];

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
        } catch (error) { console.error("Firebase initialization error:", error); }
        
        const atasehirDistricts = ["Aşık Veysel", "Atatürk", "Barbaros", "Esatpaşa", "Ferhatpaşa", "Fetih", "İçerenköy", "İnönü", "Kayışdağı", "Küçükbakkalköy", "Mevlana", "Mimar Sinan", "Mustafa Kemal", "Örnek", "Yeni Çamlıca", "Yeni Sahra", "Yenişehir"];
        const statusMap = { new: 'Yeni Başvuru', inProgress: 'İnceleniyor', appointment: 'Randevu Verildi', completed: 'Yardım Ulaştırıldı', cancelled: 'İptal Edildi' };
        const statusColors = { new: 'status-new', inProgress: 'status-inProgress', appointment: 'status-appointment', completed: 'status-completed', cancelled: 'status-cancelled' };
        
        document.addEventListener('DOMContentLoaded', () => {
            renderInitialHTML();
            addEventListeners();
            if (database) { loadAllData(); }
            document.querySelector('.nav-link[data-tab="form"]').classList.add('active');
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.classList.add('dark-mode');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun text-yellow-400"></i>';
            } else {
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon text-gray-600"></i>';
            }
        });

        function renderInitialHTML() {
            document.getElementById('formSection').innerHTML = `
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-semibold text-gray-900 flex items-center mb-6"><i class="fas fa-user text-turquoise-600 mr-2"></i>İhtiyaç Bildirim Formu</h2>
                        <form id="needsForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-semibold text-gray-900 mb-2">Ad Soyad *</label><input type="text" id="name" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                                <div><label class="block text-sm font-semibold text-gray-900 mb-2">Telefon *</label><input type="tel" id="phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-semibold text-gray-900 mb-2">Adres</label><input type="text" id="address" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                                <div><label class="block text-sm font-semibold text-gray-900 mb-2">Mahalle</label><select id="district" class="w-full px-4 py-2 border border-gray-300 rounded-lg"><option value="">Mahalle Seçin</option></select></div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-900 mb-3">İhtiyaç Türleri *</label>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    ${['food:Gıda:red:utensils', 'health:Sağlık:green:heartbeat', 'education:Eğitim:blue:graduation-cap', 'housing:Barınma:purple:home', 'employment:İstihdam:yellow:briefcase', 'legal:Hukuk:indigo:balance-scale', 'other:Diğer:gray:building'].map(n => {
                                        const [val, text, color, icon] = n.split(':');
                                        return `<label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" name="needs" value="${val}" class="rounded border-gray-300 text-turquoise-600"><div class="flex items-center space-x-2 px-3 py-2 rounded-lg bg-${color}-100 text-${color}-600"><i class="fas fa-${icon} text-sm"></i><span class="text-sm font-medium">${text}</span></div></label>`;
                                    }).join('')}
                                </div>
                            </div>
                            <div id="otherNeedContainer" class="hidden">
                                <label class="block text-sm font-semibold text-gray-900 mb-2">Diğer İhtiyaç</label><input type="text" id="otherNeed" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-900 mb-3">Aciliyet Durumu</label>
                                <div class="flex space-x-3">${['normal:Normal:green', 'high:Yüksek:yellow', 'urgent:Acil:red'].map(u => {
                                    const [val, text, color] = u.split(':');
                                    return `<label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="urgency" value="${val}" class="text-turquoise-600" ${val === 'normal' ? 'checked' : ''}><span class="px-3 py-1 rounded-full text-xs font-medium bg-${color}-100 text-${color}-800">${text}</span></label>`;
                                }).join('')}</div>
                            </div>
                            <div><label class="block text-sm font-semibold text-gray-900 mb-2">Detaylı Açıklama</label><textarea id="description" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea></div>
                            <button type="submit" class="w-full bg-turquoise-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-turquoise-700">İhtiyacı Bildir</button>
                        </form>
                    </div>
                </div>`;
            document.getElementById('dashboardSection').innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                             <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center"><i class="fas fa-exclamation-circle text-red-500 mr-2"></i>Acil İşler</h3>
                             <div id="urgentTasksList" class="space-y-3 max-h-64 overflow-y-auto"></div>
                        </div>
                         <div class="bg-white rounded-xl shadow-lg p-6">
                             <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center"><i class="fas fa-history text-turquoise-500 mr-2"></i>Son Değişiklikler</h3>
                             <div id="recentActivityList" class="space-y-3 max-h-64 overflow-y-auto"></div>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                             <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center"><i class="fas fa-chart-pie text-blue-500 mr-2"></i>Hızlı İstatistikler</h3>
                             <div class="space-y-4">
                                <div class="bg-blue-50 p-4 rounded-lg"><h4 class="font-medium text-blue-800">Bugün Gelen Başvurular</h4><p id="quickStatToday" class="text-2xl font-bold text-blue-600">0</p></div>
                                <div class="bg-yellow-50 p-4 rounded-lg"><h4 class="font-medium text-yellow-800">İncelenmeyi Bekleyen</h4><p id="quickStatPending" class="text-2xl font-bold text-yellow-600">0</p></div>
                                <div class="bg-green-50 p-4 rounded-lg"><h4 class="font-medium text-green-800">Bu Hafta Tamamlanan</h4><p id="quickStatCompleted" class="text-2xl font-bold text-green-600">0</p></div>
                             </div>
                        </div>
                    </div>
                </div>`;
            document.getElementById('submissionsSection').innerHTML = `
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold text-gray-900 flex items-center"><i class="fas fa-file-alt text-turquoise-600 mr-2"></i>Tüm Başvurular</h2>
                        <div class="flex items-center space-x-2"><span class="text-sm text-gray-800">Toplam: <span id="submissionsCount" class="font-bold">0</span></span><button id="refreshSubmissions" class="p-2 rounded-lg bg-gray-100"><i class="fas fa-sync-alt text-gray-600"></i></button></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="md:col-span-2 relative"><input type="text" id="searchInput" placeholder="İsim veya telefona göre ara..." class="w-full pl-10 pr-4 py-2 border rounded-lg"><i class="fas fa-search absolute top-3 left-3 text-gray-400"></i></div>
                        <select id="filterStatus" class="w-full px-4 py-2 border rounded-lg"><option value="all">Tüm Durumlar</option></select>
                        <select id="filterUrgency" class="w-full px-4 py-2 border rounded-lg"><option value="all">Tüm Aciliyetler</option><option value="urgent">Acil</option><option value="high">Yüksek</option><option value="normal">Normal</option></select>
                    </div>
                    <div id="submissionsList" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                    <div id="noSubmissions" class="text-center py-8 text-gray-500"><i class="fas fa-inbox text-4xl mb-4 text-gray-300"></i><p>Henüz hiçbir başvuru bulunmamaktadır.</p></div>
                </div>`;
            document.getElementById('resourcesSection').innerHTML = `
                <div class="bg-white rounded-xl shadow-lg p-6">
                     <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center"><i class="fas fa-cubes text-turquoise-600 mr-2"></i>Kaynak Yönetimi</h2>
                     <div class="space-y-4" id="resourcesList"></div>
                     <div class="mt-6 flex items-center space-x-2">
                        <input type="text" id="newResourceName" placeholder="Yeni Kaynak Adı (Örn: Bebek Bezi)" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <button id="addResourceBtn" class="bg-turquoise-600 text-white px-5 py-2 rounded-lg font-semibold"><i class="fas fa-plus"></i></button>
                     </div>
                </div>`;
             document.getElementById('reportsSection').innerHTML = `
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center"><i class="fas fa-calendar-alt text-turquoise-600 mr-2"></i>Tarihe Göre Raporlama</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 items-end">
                        <div><label class="block text-sm font-medium text-gray-900 mb-2">Başlangıç Tarihi</label><input type="date" id="reportDateStart" class="w-full px-4 py-2 border rounded-lg"></div>
                        <div><label class="block text-sm font-medium text-gray-900 mb-2">Bitiş Tarihi</label><input type="date" id="reportDateEnd" class="w-full px-4 py-2 border rounded-lg"></div>
                        <button id="generateReportBtn" class="w-full bg-turquoise-600 text-white py-2 px-4 rounded-lg font-semibold">Rapor Oluştur</button>
                    </div>
                    <div id="dailyReportContent" class="border border-gray-200 rounded-lg p-6 hidden">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Rapor: <span id="reportDateDisplay"></span></h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-green-50 p-4 rounded-lg"><h4 class="font-medium text-green-800">Toplam Başvuru</h4><p id="reportTotal" class="text-2xl font-bold text-green-600">0</p></div>
                            <div class="bg-yellow-50 p-4 rounded-lg"><h4 class="font-medium text-yellow-800">Acil Durumlar</h4><p id="reportUrgent" class="text-2xl font-bold text-yellow-600">0</p></div>
                            <div class="bg-blue-50 p-4 rounded-lg"><h4 class="font-medium text-blue-800">En Çok İhtiyaç</h4><p id="reportTopNeed" class="text-lg font-medium text-blue-600">-</p></div>
                        </div>
                        <div class="mb-4"><h4 class="font-medium text-gray-900 mb-2">İhtiyaç Dağılımı</h4><div id="reportNeedsChart" class="space-y-2"></div></div>
                        <button id="exportReportBtn" class="bg-turquoise-600 text-white px-4 py-2 rounded-lg"><i class="fas fa-download mr-2"></i>Raporu İndir (.CSV)</button>
                    </div>
                    <div id="noReportData" class="text-center py-8 text-gray-500"><i class="fas fa-file-alt text-4xl mb-4 text-gray-300"></i><p>Tarih aralığı seçip "Rapor Oluştur" butonuna basın.</p></div>
                </div>`;
            document.getElementById('managementSection').innerHTML = `
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center"><i class="fas fa-database text-turquoise-600 mr-2"></i>Veri Yönetimi</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="border border-gray-200 rounded-lg p-6">
                            <h3 class="font-medium text-gray-900 mb-4 flex items-center"><i class="fas fa-download text-green-600 mr-2"></i>Veri İndirme</h3>
                            <button id="exportBtnManagement" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold flex items-center justify-center space-x-2" disabled><i class="fas fa-file-excel"></i><span>Tüm Verileri İndir (.CSV)</span></button>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-6">
                            <h3 class="font-medium text-gray-900 mb-4 flex items-center"><i class="fas fa-trash-alt text-red-600 mr-2"></i>Veri Temizleme</h3>
                            <button id="clearDataBtn" class="w-full bg-red-600 text-white py-3 px-4 rounded-lg font-semibold flex items-center justify-center space-x-2"><i class="fas fa-eraser"></i><span>Tüm Verileri Sil</span></button>
                        </div>
                    </div>
                </div>`;
            
            populateDistrictDropdown();
            populateStatusFilterDropdown();
        }

        function addEventListeners() {
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('adminLoginBtn').addEventListener('click', () => document.getElementById('adminLoginModal').classList.remove('hidden'));
            document.getElementById('closeLoginModal').addEventListener('click', () => document.getElementById('adminLoginModal').classList.add('hidden'));
            document.getElementById('adminLoginForm').addEventListener('submit', handleAdminLogin);
            document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', handleNavigation));
            document.getElementById('needsForm').addEventListener('submit', handleFormSubmit);
            document.querySelector('input[value="other"]').addEventListener('change', (e) => document.getElementById('otherNeedContainer').classList.toggle('hidden', !e.target.checked));
            document.getElementById('refreshSubmissions').addEventListener('click', loadSubmissionsFromFirebase);
            ['searchInput', 'filterStatus', 'filterUrgency'].forEach(id => document.getElementById(id).addEventListener('input', loadSubmissionsList));
            document.getElementById('exportBtnManagement').addEventListener('click', () => exportToCSV(submissions, 'tum_basvurular'));
            document.getElementById('clearDataBtn').addEventListener('click', confirmClearAllData);
            document.getElementById('generateReportBtn').addEventListener('click', generateReportByDateRange);
            document.getElementById('exportReportBtn').addEventListener('click', exportReport);
            document.getElementById('addResourceBtn').addEventListener('click', addNewResource);
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('themeToggle').innerHTML = isDark ? '<i class="fas fa-sun text-yellow-400"></i>' : '<i class="fas fa-moon text-gray-600"></i>';
        }

        function handleAdminLogin(e) {
            e.preventDefault();
            if (document.getElementById('adminPassword').value === ADMIN_PASSWORD) {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('admin-visible'));
                document.getElementById('adminLoginModal').classList.add('hidden');
                document.getElementById('adminPassword').value = '';
                const adminBtn = document.getElementById('adminLoginBtn');
                adminBtn.innerHTML = '<i class="fas fa-sign-out-alt text-red-600"></i>';
                adminBtn.title = 'Çıkış Yap';
                adminBtn.onclick = logoutAdmin;
                loadAllData();
                navigateToTab('dashboard');
            } else { alert('Geçersiz şifre!'); }
        }

        function logoutAdmin() {
            document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('admin-visible'));
            const adminBtn = document.getElementById('adminLoginBtn');
            adminBtn.innerHTML = '<i class="fas fa-lock text-turquoise-600"></i>';
            adminBtn.title = 'Yönetici Girişi';
            adminBtn.onclick = () => document.getElementById('adminLoginModal').classList.remove('hidden');
            navigateToTab('form');
        }

        function handleNavigation(e) { navigateToTab(e.target.dataset.tab); }

        function navigateToTab(tabId) {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const activeLink = document.querySelector(`.nav-link[data-tab="${tabId}"]`);
            if(activeLink) activeLink.classList.add('active');
            document.querySelectorAll('main > div[id$="Section"]').forEach(el => el.classList.add('hidden'));
            const activeSection = document.getElementById(tabId + 'Section');
            if(activeSection) activeSection.classList.remove('hidden');
            if (tabId === 'map') {
                if (!map) initializeMap();
                setTimeout(() => map.invalidateSize(), 100);
            }
            if (tabId === 'dashboard') showDashboard();
        }

        async function loadAllData() {
            if (!database) return;
            await Promise.all([loadSubmissionsFromFirebase(), loadResourcesFromFirebase()]);
            updateAllViews();
        }
        
        async function loadSubmissionsFromFirebase() {
             try {
                const snapshot = await database.ref('submissions').once('value');
                const data = snapshot.val();
                submissions = data ? Object.keys(data).map(key => ({ ...data[key], firebaseId: key })) : [];
             } catch(error) { console.error("Error loading submissions:", error); }
        }
        
        async function loadResourcesFromFirebase() {
            try {
                const snapshot = await database.ref('resources').once('value');
                resources = snapshot.val() || {};
             } catch(error) { console.error("Error loading resources:", error); }
        }

        async function saveSubmissionToFirebase(submission) {
            if (!database) return;
            try {
                await database.ref('submissions').push(submission);
                document.getElementById('successMessageText').textContent = `Başvurunuz ${submission.submissionId} numarasıyla kaydedildi!`;
                document.getElementById('successMessage').classList.remove('hidden');
                setTimeout(() => document.getElementById('successMessage').classList.add('hidden'), 5000);
                await loadSubmissionsFromFirebase();
                updateAllViews();
            } catch (error) { console.error("Error saving submission:", error); }
        }
        
        async function updateSubmissionField(firebaseId, field, value) {
            if (!database || !firebaseId) return;
            try {
                await database.ref(`submissions/${firebaseId}/${field}`).set(value);
                const subIndex = submissions.findIndex(s => s.firebaseId === firebaseId);
                if (subIndex > -1) {
                    submissions[subIndex][field] = value;
                    submissions[subIndex].lastModified = new Date().toISOString();
                    await database.ref(`submissions/${firebaseId}/lastModified`).set(submissions[subIndex].lastModified);
                }
                updateAllViews();
            } catch (error) { console.error(`Error updating field "${field}":`, error); }
        }
        
        async function updateResource(name, quantity) {
             if (!database) return;
             try {
                await database.ref(`resources/${name}`).set(Number(quantity));
                resources[name] = Number(quantity);
             } catch (error) { console.error("Error updating resource:", error); }
        }
        
        async function addNewResource() {
            const newResourceName = document.getElementById('newResourceName').value.trim();
            if (newResourceName && !resources.hasOwnProperty(newResourceName)) {
                await updateResource(newResourceName, 0);
                document.getElementById('newResourceName').value = '';
                renderResources();
            } else if (resources.hasOwnProperty(newResourceName)) { alert("Bu kaynak zaten mevcut."); }
        }

        function updateAllViews() {
            updateStats();
            showDashboard();
            loadSubmissionsList();
            renderResources();
            updateMapMarkers();
        }

        function updateStats() {
            const totalEl = document.getElementById('totalSubmissions');
            if (totalEl) totalEl.textContent = submissions.length;
            const today = new Date().toISOString().split('T')[0];
            const todayEl = document.getElementById('todaySubmissions');
            if (todayEl) todayEl.textContent = submissions.filter(s => s.timestamp.startsWith(today)).length;
            const urgentEl = document.getElementById('urgentSubmissions');
            if (urgentEl) urgentEl.textContent = submissions.filter(s => s.urgency === 'urgent').length;
            const exportBtn = document.getElementById('exportBtnManagement');
            if (exportBtn) exportBtn.disabled = submissions.length === 0;
        }

        function showDashboard() {
            const urgentTasksList = document.getElementById('urgentTasksList');
            urgentTasksList.innerHTML = '';
            const urgentTasks = submissions.filter(s => s.urgency === 'urgent' && s.status !== 'completed' && s.status !== 'cancelled').sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 5);
            if(urgentTasks.length > 0) {
                 urgentTasks.forEach(sub => { urgentTasksList.innerHTML += `<div class="p-2 border-l-4 border-red-500 bg-gray-50 rounded-r-lg"><p class="font-semibold text-gray-800">${sub.name}</p><p class="text-sm text-gray-600">${statusMap[sub.status]}</p></div>`; });
            } else { urgentTasksList.innerHTML = `<p class="text-gray-500">Acil iş bulunmuyor.</p>`; }
            
            const recentActivityList = document.getElementById('recentActivityList');
            recentActivityList.innerHTML = '';
            const recentActivities = submissions.filter(s => s.lastModified).sort((a,b) => new Date(b.lastModified) - new Date(a.lastModified)).slice(0, 5);
            if(recentActivities.length > 0) {
                 recentActivities.forEach(sub => { recentActivityList.innerHTML += `<div class="p-2 border-l-4 border-turquoise-500 bg-gray-50 rounded-r-lg"><p class="font-semibold text-gray-800">${sub.name}</p><p class="text-sm text-gray-600">Durumu <span class="font-bold">${statusMap[sub.status]}</span> olarak güncellendi.</p></div>`; });
            } else { recentActivityList.innerHTML = `<p class="text-gray-500">Henüz bir aktivite yok.</p>`; }
            
            document.getElementById('quickStatToday').textContent = submissions.filter(s => s.timestamp.startsWith(new Date().toISOString().split('T')[0])).length;
            document.getElementById('quickStatPending').textContent = submissions.filter(s => s.status === 'new' || s.status === 'inProgress').length;
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            document.getElementById('quickStatCompleted').textContent = submissions.filter(s => s.status === 'completed' && new Date(s.timestamp) >= oneWeekAgo).length;
        }

        function renderResources() {
            const list = document.getElementById('resourcesList');
            list.innerHTML = '';
            if(Object.keys(resources).length === 0) {
                 list.innerHTML = `<p class="text-gray-500">Henüz kaynak eklenmemiş.</p>`;
                 return;
            }
            for (const [name, quantity] of Object.entries(resources)) {
                list.innerHTML += `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <span class="font-semibold text-gray-800">${name}</span>
                                        <div class="flex items-center space-x-2">
                                            <input type="number" value="${quantity}" onchange="updateResource('${name}', this.value)" class="w-24 text-center p-1 border rounded-md">
                                        </div>
                                   </div>`;
            }
        }
        
        function handleFormSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            if (!name || !phone) {
                document.getElementById('errorMessage').classList.remove('hidden');
                setTimeout(() => document.getElementById('errorMessage').classList.add('hidden'), 3000);
                return;
            }
            const needsCheckboxes = document.querySelectorAll('input[name="needs"]:checked');
            const needs = {};
            needsCheckboxes.forEach(checkbox => { needs[checkbox.value] = true; });

            const today = new Date();
            const datePart = today.toISOString().slice(0, 10).replace(/-/g, '');
            const timePart = today.getTime().toString().slice(-5);
            
            const newSubmission = {
                submissionId: `${datePart}-${timePart}`, name, phone,
                address: document.getElementById('address').value.trim(), district: document.getElementById('district').value,
                needs, otherNeed: needs.other ? document.getElementById('otherNeed').value.trim() : '',
                urgency: document.querySelector('input[name="urgency"]:checked').value,
                description: document.getElementById('description').value.trim(),
                timestamp: today.toISOString(), status: 'new', notes: ''
            };
            saveSubmissionToFirebase(newSubmission);
            document.getElementById('needsForm').reset();
            document.getElementById('otherNeedContainer').classList.add('hidden');
        }
        
        function initializeMap() {
            if (map) { map.invalidateSize(); return; }
            map = L.map('map').setView([40.9839, 29.1138], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(map);
            updateMapMarkers();
        }

        async function updateMapMarkers() {
            if (!map) return;
            markers.forEach(marker => map.removeLayer(marker));
            markers.length = 0;
            const redIcon = new L.Icon({
              iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
              shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
              iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });
            const submissionsWithAddress = submissions.filter(s => s.address);
            for (const sub of submissionsWithAddress) {
                await new Promise(resolve => setTimeout(resolve, 1100)); 
                const fullAddress = `${sub.address}, ${sub.district}, Ataşehir, İstanbul`;
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=1`);
                    const data = await response.json();
                    if (data && data.length > 0) {
                        const { lat, lon } = data[0];
                        const marker = L.marker([lat, lon], { icon: sub.urgency === 'urgent' ? redIcon : undefined }).addTo(map)
                            .bindPopup(`<b>${sub.name}</b><br>${sub.address}<br>Durum: ${statusMap[sub.status]}`);
                        markers.push(marker);
                    }
                } catch (err) { console.error("Geocoding error:", err); }
            }
        }
        
        function printSubmission(firebaseId) {
             const sub = submissions.find(s => s.firebaseId === firebaseId);
             if (!sub) return;
             const needsList = sub.needs ? Object.keys(sub.needs).map(need => ({food:'Gıda',health:'Sağlık',education:'Eğitim',housing:'Barınma',employment:'İstihdam',legal:'Hukuk',other:'Diğer'}[need])).join(', ') : 'Belirtilmemiş';
             const printWindow = window.open('', '_blank');
             printWindow.document.write(`<html><head><title>Başvuru Çıktısı - ${sub.name}</title><style>body{font-family:sans-serif; margin: 20px;} h1{font-size:20px; border-bottom:1px solid #ccc; padding-bottom:10px;} .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px;} p{margin:5px 0;} strong{display:inline-block; width:120px;}</style></head><body><h1>Başvuru Detayları (#${sub.submissionId})</h1><div class="grid"><p><strong>Ad Soyad:</strong> ${sub.name}</p><p><strong>Telefon:</strong> ${sub.phone}</p><p><strong>Adres:</strong> ${sub.address}</p><p><strong>Mahalle:</strong> ${sub.district}</p></div><h2>İhtiyaçlar</h2><p>${needsList}</p>${sub.otherNeed ? `<p><strong>Diğer İhtiyaç:</strong> ${sub.otherNeed}</p>` : ''}<h2>Açıklama</h2><p>${sub.description || 'Yok'}</p><h2>İşlem Notları</h2><p>${sub.notes || 'Yok'}</p><hr><p><strong>Tarih:</strong> ${new Date(sub.timestamp).toLocaleString('tr-TR')}</p><p><strong>Durum:</strong> ${statusMap[sub.status]}</p><p><strong>Aciliyet:</strong> ${sub.urgency}</p></body></html>`);
             printWindow.document.close();
             printWindow.focus();
             setTimeout(() => { printWindow.print(); }, 500);
        }
        
        function confirmClearAllData() {
            if (confirm('Tüm verileri silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!')) {
                if (confirm('Son kez onaylıyor musunuz? Tüm başvuru kayıtları kalıcı olarak silinecek!')) {
                    clearAllData();
                }
            }
        }
        
        async function clearAllData() {
            if (!database) return;
            try {
                await database.ref('submissions').set(null);
                await database.ref('resources').set(null);
                submissions = [];
                resources = {};
                updateAllViews();
                alert('Tüm veriler başarıyla silindi!');
            } catch (error) { console.error("Veri temizlenirken hata:", error); }
        }
        
        function exportReport() {
            if(reportSubmissions.length > 0) {
                 const startDate = document.getElementById('reportDateStart').value;
                 const endDate = document.getElementById('reportDateEnd').value;
                 exportToCSV(reportSubmissions, `rapor_${startDate}_${endDate}`);
            }
        }
        
        function exportToCSV(dataToExport, filenamePrefix) {
            if (dataToExport.length === 0) return;
            const headers = ['Başvuru No', 'Durum', 'Ad Soyad', 'Telefon', 'Adres', 'Mahalle', 'Gıda', 'Sağlık', 'Eğitim', 'Barınma', 'İstihdam', 'Hukuk', 'Diğer', 'Diğer İhtiyaç', 'Aciliyet', 'Açıklama', 'Notlar', 'Tarih'];
            const csvContent = [ headers.join(','), ...dataToExport.map(sub => [`"${sub.submissionId}"`,`"${statusMap[sub.status] || 'Bilinmiyor'}"`,`"${sub.name}"`, `"${sub.phone}"`, `"${sub.address}"`, `"${sub.district}"`,sub.needs.food ? 'Evet' : 'Hayır', sub.needs.health ? 'Evet' : 'Hayır', sub.needs.education ? 'Evet' : 'Hayır', sub.needs.housing ? 'Evet' : 'Hayır', sub.needs.employment ? 'Evet' : 'Hayır', sub.needs.legal ? 'Evet' : 'Hayır', sub.needs.other ? 'Evet' : 'Hayır', `"${sub.otherNeed || ''}"`, sub.urgency === 'urgent' ? 'Acil' : sub.urgency === 'high' ? 'Yüksek' : 'Normal', `"${(sub.description || '').replace(/"/g, '""')}"`, `"${(sub.notes || '').replace(/"/g, '""')}"`, `"${new Date(sub.timestamp).toLocaleString('tr-TR')}"`].join(','))].join('\n');
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `${filenamePrefix}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function populateDistrictDropdown() {
            const districtSelect = document.getElementById('district');
            atasehirDistricts.sort().forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
        }
        function populateStatusFilterDropdown() {
            const statusFilter = document.getElementById('filterStatus');
            for (const [key, value] of Object.entries(statusMap)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = value;
                statusFilter.appendChild(option);
            }
        }
        function loadSubmissionsList() {
            const listContainer = document.getElementById('submissionsList');
            listContainer.innerHTML = '';
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const urgencyFilter = document.getElementById('filterUrgency').value;
            let filteredSubmissions = submissions.filter(sub => {
                const nameMatch = sub.name.toLowerCase().includes(searchTerm);
                const phoneMatch = sub.phone.includes(searchTerm);
                const statusMatch = statusFilter === 'all' || sub.status === statusFilter;
                const urgencyMatch = urgencyFilter === 'all' || sub.urgency === urgencyFilter;
                return (nameMatch || phoneMatch) && statusMatch && urgencyMatch;
            });
            document.getElementById('noSubmissions').classList.toggle('hidden', filteredSubmissions.length > 0);
            document.getElementById('submissionsCount').textContent = filteredSubmissions.length;
            const sortedSubmissions = filteredSubmissions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            sortedSubmissions.forEach(sub => {
                const needsLabels = {food:'Gıda',health:'Sağlık',education:'Eğitim',housing:'Barınma',employment:'İstihdam',legal:'Hukuk',other:'Diğer'};
                const needsList = sub.needs ? Object.keys(sub.needs).map(need => needsLabels[need]).join(', ') : 'Belirtilmemiş';
                let statusDropdownHTML = `<select onchange="updateSubmissionField('${sub.firebaseId}', 'status', this.value)" class="w-full p-1 border border-gray-300 rounded-md text-sm">`;
                for (const [key, value] of Object.entries(statusMap)) { statusDropdownHTML += `<option value="${key}" ${sub.status === key ? 'selected' : ''}>${value}</option>`; }
                statusDropdownHTML += `</select>`;
                const submissionElement = document.createElement('div');
                submissionElement.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow';
                submissionElement.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900">${sub.name}</h3>
                            <p class="text-sm text-gray-800">${sub.phone}</p>
                            <p class="text-xs text-gray-500 mt-1">#${sub.submissionId}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                             <span class="status-badge ${statusColors[sub.status] || 'bg-gray-200'}">${statusMap[sub.status] || sub.status}</span>
                             <button onclick="printSubmission('${sub.firebaseId}')" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600"><i class="fas fa-print"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <p class="text-sm text-gray-800 font-medium"><i class="fas fa-map-marker-alt mr-2 text-gray-400"></i>${sub.address || '...'}</p>
                            <p class="text-sm text-gray-800 font-medium"><i class="fas fa-city mr-2 text-gray-400"></i>${sub.district || '...'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-800 font-medium"><i class="fas fa-list mr-2 text-gray-400"></i>${needsList}</p>
                            ${sub.otherNeed ? `<p class="text-sm text-gray-800 font-medium"><i class="fas fa-plus mr-2 text-gray-400"></i>${sub.otherNeed}</p>` : ''}
                        </div>
                    </div>
                    ${sub.description ? `<p class="text-sm font-medium text-gray-900 bg-gray-100 p-3 rounded-lg mb-3">${sub.description}</p>` : ''}
                    <div class="border-t border-gray-200 pt-3 mt-3">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-xs font-semibold text-gray-700 mb-1">İşlem Notları</label>
                                <textarea id="notes-${sub.firebaseId}" class="w-full text-sm p-2 border rounded-md bg-gray-100" rows="2">${sub.notes || ''}</textarea>
                                <button onclick="updateSubmissionField('${sub.firebaseId}', 'notes', document.getElementById('notes-${sub.firebaseId}').value)" class="mt-1 text-xs bg-turquoise-100 text-turquoise-800 px-2 py-1 rounded hover:bg-turquoise-200">Notu Kaydet</button>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">Durumu Değiştir</label>
                                ${statusDropdownHTML}
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-3 text-right"><i class="fas fa-clock mr-1"></i>${new Date(sub.timestamp).toLocaleString('tr-TR')}</p>`;
                listContainer.appendChild(submissionElement);
            });
        }
        function setupReportDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDateStart').value = today;
            document.getElementById('reportDateEnd').value = today;
        }
        function generateReportByDateRange() {
            const startDate = document.getElementById('reportDateStart').value;
            const endDate = document.getElementById('reportDateEnd').value;
            if (!startDate || !endDate) return;
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999); 
            reportSubmissions = submissions.filter(sub => {
                const subDate = new Date(sub.timestamp);
                return subDate >= start && subDate <= end;
            });
            const reportContent = document.getElementById('dailyReportContent');
            const noReportData = document.getElementById('noReportData');
            reportContent.classList.toggle('hidden', reportSubmissions.length === 0);
            noReportData.classList.toggle('hidden', reportSubmissions.length > 0);
            noReportData.textContent = reportSubmissions.length === 0 ? "Seçilen tarih aralığı için veri bulunmamaktadır." : 'Lütfen bir tarih aralığı seçip "Rapor Oluştur" butonuna basın.';
            if (reportSubmissions.length === 0) return;
            const startStr = start.toLocaleDateString('tr-TR');
            const endStr = end.toLocaleDateString('tr-TR');
            document.getElementById('reportDateDisplay').textContent = `${startStr} - ${endStr}`;
            document.getElementById('reportTotal').textContent = reportSubmissions.length;
            document.getElementById('reportUrgent').textContent = reportSubmissions.filter(sub => sub.urgency === 'urgent').length;
            const needsCount = { food: 0, health: 0, education: 0, housing: 0, employment: 0, legal: 0, other: 0 };
            reportSubmissions.forEach(sub => { if(sub.needs) Object.keys(needsCount).forEach(need => { if (sub.needs[need]) needsCount[need]++; }); });
            const needsLabels = { food: 'Gıda', health: 'Sağlık', education: 'Eğitim', housing: 'Barınma', employment: 'İstihdam', legal: 'Hukuk', other: 'Diğer' };
            const topNeed = Object.entries(needsCount).reduce((a, b) => a[1] > b[1] ? a : b, [null, 0]);
            document.getElementById('reportTopNeed').textContent = topNeed[1] > 0 ? needsLabels[topNeed[0]] : '-';
            const reportNeedsChart = document.getElementById('reportNeedsChart');
            reportNeedsChart.innerHTML = '';
            Object.entries(needsCount).forEach(([key, count]) => {
                if (count > 0) {
                    const totalNeeds = Object.values(needsCount).reduce((a, b) => a + b, 0);
                    const percentage = totalNeeds > 0 ? Math.round((count / totalNeeds) * 100) : 0;
                    reportNeedsChart.innerHTML += `<div class="flex items-center justify-between"><span class="text-sm font-medium">${needsLabels[key]}</span><div class="flex items-center space-x-2"><div class="w-24 bg-gray-200 rounded-full h-2"><div class="bg-turquoise-600 h-2 rounded-full" style="width: ${percentage}%"></div></div><span class="text-sm text-gray-600">${count}</span></div></div>`;
                }
            });
        }
    </script>
</body>
</html>

