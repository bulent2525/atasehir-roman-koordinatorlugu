<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İstanbul Vali Koordinatörü Yardım Hattı</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'turquoise': {
                            50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 300: '#5eead4',
                            400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e',
                            800: '#115e59', 900: '#134e4a'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        @keyframes gradient-move {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, #23a6d5, #23d5ab, #e73c7e, #ee7752);
            background-size: 400% 400%;
            animation: gradient-move 15s ease infinite;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.5);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        }

        .dark-mode .glass-panel {
            background: rgba(29, 38, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        
        .dark-mode { background: #0f172a; }
        .dark-mode .text-gray-900 { color: #f8fafc !important; }
        .dark-mode .text-gray-800 { color: #e5e7eb !important; }
        .dark-mode .text-gray-700 { color: #d1d5db !important; }
        .dark-mode .text-gray-600 { color: #94a3b8 !important; }
        .dark-mode .border-gray-200 { border-color: #374151 !important; }
        .dark-mode .border-gray-300 { border-color: #334155 !important; }
        .dark-mode input, .dark-mode textarea, .dark-mode select { background-color: rgba(51, 65, 85, 0.5) !important; color: #f8fafc !important; border-color: #475569 !important; }
        .dark-mode .bg-gray-50 { background-color: rgba(55, 65, 81, 0.7) !important; color: #e5e7eb; }
        .dark-mode .bg-gray-100 { background-color: rgba(55, 65, 81, 0.5) !important; }
        .fixed-notification { position: fixed; top: 1rem; right: 1rem; z-index: 1050; }
        .nav-link { transition: all 0.3s ease; }
        .nav-link:hover { transform: translateY(-2px); color: #14b8a6 }
        .nav-link.active { background-color: #14b8a6; color: white !important; box-shadow: 0 4px 14px 0 rgba(20, 184, 166, 0.3); }
        .admin-only { display: none; }
        .admin-visible { display: block !important; }
        .super-admin-only { display: none; }
        .super-admin-visible { display: block !important; }
        .status-badge { padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; text-transform: capitalize; }
        .status-new { background-color: #e0f2fe; color: #0c4a6e; }
        .status-inProgress { background-color: #fef9c3; color: #713f12; }
        .status-appointment { background-color: #e0e7ff; color: #312e81; }
        .status-completed { background-color: #dcfce7; color: #15803d; }
        .status-cancelled { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Firebase SDK (Uyumluluk Versiyonu) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <!-- Header -->
    <header class="sticky top-0 z-40 glass-panel">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-turquoise-600 p-3 rounded-full shadow-lg">
                        <i class="fas fa-hands-holding-child text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900">İstanbul Vali Koordinatörü Yardım Hattı</h1>
                        <p class="text-gray-800 mt-1">Anadolu Yakası Koordinasyon ve Destek Sistemi</p>
                    </div>
                </div>
                <div class="mt-4 md:mt-0 flex items-center space-x-4">
                    <button id="themeToggle" class="p-2 rounded-full glass-panel hover:bg-gray-200/50 transition-colors"><i class="fas fa-moon text-gray-800"></i></button>
                    <button id="authBtn" class="p-2 rounded-full glass-panel hover:bg-gray-200/50 transition-colors"><i class="fas fa-lock text-turquoise-600"></i></button>
                </div>
            </div>
        </div>
    </header>

    <!-- Modals -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4"><h3 id="authTitle" class="text-lg font-semibold text-gray-900">Koordinatör Girişi</h3><button id="closeAuthModal" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div>
            <form id="loginForm" class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-900 mb-2">E-posta</label><input type="email" id="loginEmail" class="w-full px-4 py-2 border-none rounded-lg" required></div>
                <div><label class="block text-sm font-medium text-gray-900 mb-2">Şifre</label><input type="password" id="loginPassword" class="w-full px-4 py-2 border-none rounded-lg" required></div>
                <button type="submit" class="w-full bg-turquoise-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-turquoise-700 shadow-md">Giriş Yap</button>
                <p class="text-sm text-center text-gray-700">Hesabınız yok mu? <button type="button" id="showRegisterBtn" class="font-semibold text-turquoise-700">Kayıt Ol</button></p>
            </form>
            <form id="registerForm" class="space-y-4 hidden">
                <div><label class="block text-sm font-medium text-gray-900 mb-2">E-posta</label><input type="email" id="registerEmail" class="w-full px-4 py-2 border-none rounded-lg" required></div>
                <div><label class="block text-sm font-medium text-gray-900 mb-2">Şifre</label><input type="password" id="registerPassword" class="w-full px-4 py-2 border-none rounded-lg" required></div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 shadow-md">Kayıt Ol (İlk Super Admin)</button>
                <p class="text-sm text-center text-gray-700">Hesabınız var mı? <button type="button" id="showLoginBtn" class="font-semibold text-turquoise-700">Giriş Yap</button></p>
            </form>
        </div>
    </div>
    <div id="smsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-lg mx-4">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold text-gray-900">Hızlı SMS Gönder</h3><button id="closeSmsModal" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div>
            <div class="space-y-2 mb-4" id="smsTemplates"></div>
            <textarea id="smsContent" class="w-full p-2 border-none rounded-lg" rows="4"></textarea>
            <button id="copySmsBtn" class="mt-2 w-full bg-turquoise-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-turquoise-700 shadow-md">Metni Kopyala</button>
        </div>
    </div>
    <div id="geminiAnalysisModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-2xl mx-4">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold text-gray-900">✨ Gemini Aylık Analizi</h3><button id="closeGeminiModal" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div>
            <div id="geminiAnalysisResult" class="p-4 bg-gray-50 rounded-lg max-h-96 overflow-y-auto"></div>
        </div>
    </div>
    
    <!-- Navigation -->
    <nav id="mainNav" class="glass-panel sticky top-[108px] z-30 hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-2 md:space-x-4 overflow-x-auto py-2">
                <button class="nav-link py-2 px-4 rounded-full text-gray-800 font-medium flex-shrink-0" data-tab="form">İhtiyaç Bildirimi</button>
                <button class="nav-link py-2 px-4 rounded-full text-gray-800 font-medium admin-only flex-shrink-0" data-tab="submissions">Başvurular</button>
                <button class="nav-link py-2 px-4 rounded-full text-gray-800 font-medium admin-only flex-shrink-0" data-tab="resources">Kaynaklar</button>
                <button class="nav-link py-2 px-4 rounded-full text-gray-800 font-medium admin-only flex-shrink-0" data-tab="reports">Raporlar</button>
                <button class="nav-link py-2 px-4 rounded-full text-gray-800 font-medium super-admin-only flex-shrink-0" data-tab="coordinators">Koordinatörler</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Login Prompt -->
        <div id="loginPrompt" class="glass-panel rounded-2xl p-8 text-center">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Hoş Geldiniz</h2>
            <p class="text-gray-800 mb-6">Lütfen devam etmek için koordinatör hesabınızla giriş yapın.</p>
            <button id="loginPromptBtn" class="bg-turquoise-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-turquoise-700 shadow-lg">Giriş Yap</button>
        </div>

        <!-- Sections -->
        <div id="formSection" class="grid grid-cols-1 lg:grid-cols-3 gap-8 hidden"></div>
        <div id="submissionsSection" class="hidden admin-only"></div>
        <div id="resourcesSection" class="hidden admin-only"></div>
        <div id="reportsSection" class="hidden admin-only"></div>
        <div id="coordinatorsSection" class="hidden super-admin-only"></div>
    </main>

    <footer class="mt-12 text-center py-8">
        <p class="text-gray-800">© <span id="currentYear"></span> İstanbul Vali Koordinatörü Yardım Hattı</p>
    </footer>

    <script>
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        
        // DÜZELTİLMİŞ Firebase yapılandırması
        const firebaseConfig = {
            apiKey: "AIzaSyC0qeYrGc7fux8Ym4eEilnG7HMuOWsRigk",
            authDomain: "atasehir-roman-koordinatoru.firebaseapp.com",
            databaseURL: "https://atasehir-roman-koordinatoru-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "atasehir-roman-koordinatoru",
            storageBucket: "atasehir-roman-koordinatoru.appspot.com", // Burası düzeltildi
            messagingSenderId: "1090340718017",
            appId: "1:1090340718017:web:52980a10227508eec5db40"
        };

        let database = null, auth = null, submissions = [], resources = {}, coordinators = [];
        let currentCalendarDate = new Date();
        let currentUser = null; 
        let userData = null; 

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();
        } catch (error) { console.error("Firebase initialization error:", error); }
        
        const anadoluDistricts = ["Adalar", "Ataşehir", "Beykoz", "Çekmeköy", "Kadıköy", "Kartal", "Maltepe", "Pendik", "Sancaktepe", "Sultanbeyli", "Şile", "Tuzla", "Ümraniye", "Üsküdar"];
        const statusMap = { new: 'Yeni Başvuru', inProgress: 'İnceleniyor', appointment: 'Randevu Verildi', completed: 'Yardım Ulaştırıldı', cancelled: 'İptal Edildi' };
        const statusColors = { new: 'status-new', inProgress: 'status-inProgress', appointment: 'status-appointment', completed: 'status-completed', cancelled: 'status-cancelled' };
        
        document.addEventListener('DOMContentLoaded', () => {
            renderInitialHTML();
            addEventListeners();
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await fetchUserData(user.uid);
                    if (userData) { // Sadece veritabanında kaydı olan onaylı kullanıcılar devam etsin
                        initializeAdminUI();
                        loadAllData();
                    } else {
                        alert("Hesabınız henüz Super Admin tarafından onaylanmamış.");
                        auth.signOut();
                        showLoginUI();
                    }
                } else {
                    currentUser = null;
                    userData = null;
                    showLoginUI();
                }
            });

            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.classList.add('dark-mode');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun text-yellow-400"></i>';
            } else {
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon text-gray-800"></i>';
            }
        });

        async function fetchUserData(uid) {
            try {
                const snapshot = await database.ref(`coordinators/${uid}`).once('value');
                const data = snapshot.val();
                if (data && data.role !== 'pending') {
                    userData = data;
                } else {
                    userData = null; // Onaylanmamış veya rolü yok
                }
            } catch (error) {
                console.error("Kullanıcı verisi alınırken hata:", error);
                userData = null;
            }
        }
        
        function initializeAdminUI() {
            document.getElementById('loginPrompt').classList.add('hidden');
            document.getElementById('mainNav').classList.remove('hidden');
            document.querySelectorAll('.admin-only').forEach(el => el.classList.add('admin-visible'));
            
            if (userData && userData.role === 'superadmin') {
                document.querySelectorAll('.super-admin-only').forEach(el => el.classList.add('super-admin-visible'));
            } else {
                document.querySelectorAll('.super-admin-only').forEach(el => el.classList.remove('super-admin-visible'));
            }

            const authBtn = document.getElementById('authBtn');
            authBtn.innerHTML = '<i class="fas fa-sign-out-alt text-red-600"></i>';
            authBtn.title = 'Çıkış Yap';
            authBtn.onclick = handleLogout;
            
            updateDistrictFilters();
            navigateToTab('form');
            document.querySelector('.nav-link[data-tab="form"]').classList.add('active');
        }

        function showLoginUI() {
            document.getElementById('loginPrompt').classList.remove('hidden');
            document.getElementById('mainNav').classList.add('hidden');
            document.querySelectorAll('.admin-only, .super-admin-only').forEach(el => el.classList.remove('admin-visible'));
            document.querySelectorAll('main > div[id$="Section"]').forEach(el => el.classList.add('hidden'));

            const authBtn = document.getElementById('authBtn');
            authBtn.innerHTML = '<i class="fas fa-lock text-turquoise-600"></i>';
            authBtn.title = 'Giriş Yap';
            authBtn.onclick = () => document.getElementById('authModal').classList.remove('hidden');
        }

        function renderInitialHTML() {
            document.getElementById('formSection').innerHTML = `<div class="lg:col-span-2"><div class="glass-panel rounded-2xl p-6"><h2 class="text-xl font-semibold text-gray-900 flex items-center mb-6"><i class="fas fa-user text-turquoise-600 mr-2"></i>İhtiyaç Bildirim Formu</h2><form id="needsForm" class="space-y-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-semibold text-gray-900 mb-2">Ad Soyad *</label><input type="text" id="name" class="w-full px-4 py-2 border-none rounded-lg" required></div><div><label class="block text-sm font-semibold text-gray-900 mb-2">Telefon *</label><input type="tel" id="phone" class="w-full px-4 py-2 border-none rounded-lg" required></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-semibold text-gray-900 mb-2">Adres</label><input type="text" id="address" class="w-full px-4 py-2 border-none rounded-lg"></div><div><label class="block text-sm font-semibold text-gray-900 mb-2">İlçe</label><select id="district" class="w-full px-4 py-2 border-none rounded-lg"><option value="">İlçe Seçin</option></select></div></div><div><label class="block text-sm font-semibold text-gray-900 mb-3">İhtiyaç Türleri *</label><div class="grid grid-cols-2 md:grid-cols-3 gap-3">${['food:Gıda:red:utensils','health:Sağlık:green:heartbeat','education:Eğitim:blue:graduation-cap','housing:Barınma:purple:home','employment:İstihdam:yellow:briefcase','legal:Hukuk:indigo:balance-scale','other:Diğer:gray:building'].map(n=>{const [v,t,c,i]=n.split(':');return `<label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" name="needs" value="${v}" class="h-4 w-4 rounded border-gray-300 text-turquoise-600 focus:ring-turquoise-500"><div class="flex items-center space-x-2 px-3 py-2 rounded-lg bg-${c}-100 text-${c}-800 font-medium"><i class="fas fa-${i} text-sm"></i><span>${t}</span></div></label>`}).join('')}</div></div><div id="otherNeedContainer" class="hidden"><label class="block text-sm font-semibold text-gray-900 mb-2">Diğer İhtiyaç</label><input type="text" id="otherNeed" class="w-full px-4 py-2 border-none rounded-lg"></div><div><label class="block text-sm font-semibold text-gray-900 mb-3">Aciliyet Durumu</label><div class="flex space-x-3">${['normal:Normal:green','high:Yüksek:yellow','urgent:Acil:red'].map(u=>{const [v,t,c]=u.split(':');return `<label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="urgency" value="${v}" class="text-turquoise-600" ${v==='normal'?'checked':''}><span class="px-3 py-1 rounded-full text-xs font-medium bg-${c}-100 text-${c}-800">${t}</span></label>`}).join('')}</div></div><div><label class="block text-sm font-semibold text-gray-900 mb-2">Detaylı Açıklama</label><textarea id="description" rows="4" class="w-full px-4 py-2 border-none rounded-lg"></textarea></div><button type="submit" class="w-full bg-turquoise-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-turquoise-700 shadow-lg">İhtiyacı Bildir</button></form></div></div>`;
            document.getElementById('submissionsSection').innerHTML = `<div class="glass-panel rounded-2xl p-6"><div class="flex flex-wrap items-center justify-between gap-4 mb-6"><div id="submissionsHeader"><h2 class="text-xl font-semibold text-gray-900 flex items-center"><i class="fas fa-file-alt text-turquoise-600 mr-2"></i>Başvurular</h2></div><div class="flex items-center space-x-2"><span class="text-sm text-gray-800">Toplam: <span id="submissionsCount" class="font-bold">0</span></span><button id="exportBtn" class="p-2 rounded-full glass-panel text-green-600" title="Tüm Verileri İndir (.CSV)"><i class="fas fa-file-excel"></i></button><button id="refreshSubmissions" class="p-2 rounded-full glass-panel"><i class="fas fa-sync-alt text-gray-800"></i></button></div></div><div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"><div class="md:col-span-2 relative"><input type="text" id="searchInput" placeholder="İsim veya telefona göre ara..." class="w-full pl-10 pr-4 py-2 border-none rounded-lg"><i class="fas fa-search absolute top-3 left-3 text-gray-400"></i></div><select id="filterDistrict" class="w-full px-4 py-2 border-none rounded-lg"><option value="all">Tüm İlçeler</option></select><select id="filterStatus" class="w-full px-4 py-2 border-none rounded-lg"><option value="all">Tüm Durumlar</option></select><select id="filterUrgency" class="w-full px-4 py-2 border-none rounded-lg"><option value="all">Tüm Aciliyetler</option><option value="urgent">Acil</option><option value="high">Yüksek</option><option value="normal">Normal</option></select></div><div id="submissionsList" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div><div id="noSubmissions" class="text-center py-8 text-gray-500"><i class="fas fa-inbox text-4xl mb-4"></i><p>Henüz hiçbir başvuru bulunmamaktadır.</p></div></div>`;
            document.getElementById('resourcesSection').innerHTML = `<div class="glass-panel rounded-2xl p-6"><h2 class="text-xl font-semibold text-gray-900 mb-2 flex items-center"><i class="fas fa-cubes text-turquoise-600 mr-2"></i>Kaynaklar</h2><p class="text-sm text-gray-800 mb-6">Bir başvurunun durumu <strong class="text-gray-900">'Yardım Ulaştırıldı'</strong> olarak değiştirildiğinde, işlem notlarına <code class="bg-gray-200 dark:bg-gray-700 text-sm p-1 rounded">2 adet Gıda Kolisi</code> gibi yazılan ürünler stoktan otomatik düşülür.</p><div class="space-y-4" id="resourcesList"></div><div class="mt-6 super-admin-only"><h3 class="text-lg font-semibold text-gray-900 mb-2">Yeni Kaynak Ekle</h3><div class="flex items-center space-x-2"><input type="text" id="newResourceName" placeholder="Yeni Kaynak Adı (Örn: Bebek Bezi)" class="w-full px-4 py-2 border-none rounded-lg"><input type="number" id="newResourceMinStock" placeholder="Min. Stok" class="w-24 px-4 py-2 border-none rounded-lg"><button id="addResourceBtn" class="bg-turquoise-600 text-white px-5 py-2 rounded-lg font-semibold shadow-md"><i class="fas fa-plus"></i></button></div></div></div>`;
            document.getElementById('coordinatorsSection').innerHTML = `<div class="glass-panel rounded-2xl p-6"><h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center"><i class="fas fa-users-cog text-turquoise-600 mr-2"></i>Koordinatör Yönetimi</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="space-y-4"><h3 class="font-semibold text-gray-900">Yeni Koordinatör Ekle/Düzenle</h3><form id="coordinatorForm" class="space-y-3"><input type="email" id="coordinatorEmail" placeholder="Koordinatör E-posta" class="w-full p-2 border-none rounded-lg" required><select id="coordinatorDistrict" class="w-full p-2 border-none rounded-lg" required><option value="">İlçe Seçin</option></select><select id="coordinatorRole" class="w-full p-2 border-none rounded-lg" required><option value="pending">Onay Bekliyor</option><option value="coordinator">Koordinatör</option><option value="superadmin">Super Admin</option></select><button type="submit" class="w-full bg-turquoise-600 text-white py-2 rounded-lg font-semibold shadow-md">Kaydet/Güncelle</button></form></div><div class="space-y-4"><h3 class="font-semibold text-gray-900">Mevcut Koordinatörler</h3><div id="coordinatorsList" class="space-y-2 max-h-96 overflow-y-auto"></div></div></div></div>`;
            document.getElementById('reportsSection').innerHTML = `<div class="glass-panel rounded-2xl p-6"><h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center"><i class="fas fa-calendar-alt text-turquoise-600 mr-2"></i>Raporlar</h2><div class="border-b border-gray-200 mb-4"><nav class="-mb-px flex space-x-8" aria-label="Tabs"><button id="tab-daterange" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-turquoise-500 text-turquoise-600">Tarih Aralığı</button><button id="tab-calendar" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Aylık Takvim</button><button id="tab-neighborhood" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Mahalle Analizi</button></nav></div><div id="daterange-report-content"></div><div id="calendar-report-content" class="hidden"></div><div id="neighborhood-report-content" class="hidden"></div></div>`;
            populateDistrictDropdown();
            populateStatusFilterDropdown();
            populateCoordinatorDistrictDropdown();
        }

        function addEventListeners() {
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('authBtn').addEventListener('click', () => document.getElementById('authModal').classList.remove('hidden'));
            document.getElementById('loginPromptBtn').addEventListener('click', () => document.getElementById('authModal').classList.remove('hidden'));
            document.getElementById('closeAuthModal').addEventListener('click', () => document.getElementById('authModal').classList.add('hidden'));
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('showRegisterBtn').addEventListener('click', () => { document.getElementById('loginForm').classList.add('hidden'); document.getElementById('registerForm').classList.remove('hidden'); document.getElementById('authTitle').textContent = 'Yeni Kayıt'; });
            document.getElementById('showLoginBtn').addEventListener('click', () => { document.getElementById('registerForm').classList.add('hidden'); document.getElementById('loginForm').classList.remove('hidden'); document.getElementById('authTitle').textContent = 'Koordinatör Girişi'; });
            document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', handleNavigation));
            document.getElementById('needsForm').addEventListener('submit', handleFormSubmit);
            document.querySelector('input[value="other"]').addEventListener('change', (e) => document.getElementById('otherNeedContainer').classList.toggle('hidden', !e.target.checked));
            document.getElementById('refreshSubmissions').addEventListener('click', loadAllData);
            ['searchInput', 'filterStatus', 'filterUrgency', 'filterDistrict'].forEach(id => document.getElementById(id).addEventListener('input', loadSubmissionsList));
            document.getElementById('exportBtn').addEventListener('click', () => exportToCSV(submissions, 'tum_basvurular'));
            document.getElementById('addResourceBtn').addEventListener('click', addNewResource);
            document.getElementById('closeSmsModal').addEventListener('click', () => document.getElementById('smsModal').classList.add('hidden'));
            document.getElementById('copySmsBtn').addEventListener('click', copySmsContent);
            document.getElementById('coordinatorForm').addEventListener('submit', handleCoordinatorUpdate);
            document.getElementById('closeGeminiModal').addEventListener('click', () => document.getElementById('geminiAnalysisModal').classList.add('hidden'));
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('themeToggle').innerHTML = isDark ? '<i class="fas fa-sun text-yellow-400"></i>' : '<i class="fas fa-moon text-gray-800"></i>';
        }

        async function handleLogin(e) { e.preventDefault(); const email = document.getElementById('loginEmail').value; const password = document.getElementById('loginPassword').value; try { await auth.signInWithEmailAndPassword(email, password); document.getElementById('authModal').classList.add('hidden'); } catch (error) { alert("Giriş yapılamadı: " + error.message); } }
        async function handleRegister(e) { 
            e.preventDefault(); 
            const email = document.getElementById('registerEmail').value; 
            const password = document.getElementById('registerPassword').value; 
            try {
                const userCountSnapshot = await database.ref('coordinators').once('value');
                const isFirstUser = userCountSnapshot.numChildren() === 0;

                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const uid = userCredential.user.uid;

                let newUserRole = 'pending';
                let newUserDistrict = null;

                if (isFirstUser) {
                    newUserRole = 'superadmin';
                    newUserDistrict = 'Hepsi';
                    alert('İlk Super Admin hesabı başarıyla oluşturuldu! Lütfen giriş yapın.');
                } else {
                    alert('Kayıt başvurunuz alındı. Lütfen Super Admin onayı bekleyin.');
                }
                
                await database.ref(`coordinators/${uid}`).set({ email: email, role: newUserRole, district: newUserDistrict });
                document.getElementById('authModal').classList.add('hidden');
                auth.signOut();
            } catch (error) { 
                alert("Kayıt hatası: " + error.message); 
            } 
        }
        async function handleLogout() { await auth.signOut(); showLoginUI(); }
        
        async function handleCoordinatorUpdate(e) {
            e.preventDefault();
            const email = document.getElementById('coordinatorEmail').value;
            const district = document.getElementById('coordinatorDistrict').value;
            const role = document.getElementById('coordinatorRole').value;
            
            const userToUpdate = coordinators.find(c => c.email === email);
            if (userToUpdate) {
                try {
                    await database.ref(`coordinators/${userToUpdate.uid}`).update({ role, district });
                    alert('Koordinatör güncellendi!');
                    loadCoordinators();
                    document.getElementById('coordinatorForm').reset();
                } catch (error) {
                    alert('Güncelleme hatası: ' + error.message);
                }
            } else {
                alert('Bu e-posta ile kayıtlı bir kullanıcı bulunamadı. Kullanıcının önce "Kayıt Ol" ekranından kayıt olması gerekmektedir.');
            }
        }

        function handleNavigation(e) { navigateToTab(e.target.dataset.tab); }
        function navigateToTab(tabId) { document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); const activeLink = document.querySelector(`.nav-link[data-tab="${tabId}"]`); if(activeLink) activeLink.classList.add('active'); document.querySelectorAll('main > div[id$="Section"]').forEach(el => el.classList.add('hidden')); const activeSection = document.getElementById(tabId + 'Section'); if(activeSection) activeSection.classList.remove('hidden'); if(tabId === 'reports') initializeReportsTab(); if(tabId === 'coordinators') loadCoordinators(); }

        async function loadAllData() { if (!database || !userData) return; await Promise.all([loadSubmissionsFromFirebase(), loadResourcesFromFirebase()]); if (userData.role === 'superadmin') { await loadCoordinators(); } updateAllViews(); }
        async function loadSubmissionsFromFirebase() { 
            try { 
                let query = database.ref('submissions'); 
                if (userData.role === 'coordinator') { 
                    query = query.orderByChild('district').equalTo(userData.district); 
                }
                const snapshot = await query.once('value'); 
                const data = snapshot.val(); 
                submissions = data ? Object.keys(data).map(key => ({ ...data[key], firebaseId: key })) : []; 
            } catch(error) { console.error("Error loading submissions:", error); } 
        }
        async function loadResourcesFromFirebase() { try { const snapshot = await database.ref('resources').once('value'); resources = snapshot.val() || {}; } catch(error) { console.error("Error loading resources:", error); } }
        async function loadCoordinators() { try { const snapshot = await database.ref('coordinators').once('value'); const data = snapshot.val(); coordinators = data ? Object.keys(data).map(key => ({ ...data[key], uid: key })) : []; renderCoordinators(); } catch(error) { console.error("Error loading coordinators:", error); } }
        async function saveSubmissionToFirebase(submission) { if (!database) return; try { await database.ref('submissions').push(submission); document.getElementById('successMessageText').textContent = `Başvurunuz ${submission.submissionId} numarasıyla kaydedildi!`; document.getElementById('successMessage').classList.remove('hidden'); setTimeout(() => document.getElementById('successMessage').classList.add('hidden'), 5000); await loadAllData(); } catch (error) { console.error("Error saving submission:", error); } }
        async function updateSubmissionField(firebaseId, field, value) { if (!database || !firebaseId) return; try { const subIndex = submissions.findIndex(s => s.firebaseId === firebaseId); if (subIndex > -1) { const oldStatus = submissions[subIndex].status; await database.ref(`submissions/${firebaseId}/${field}`).set(value); submissions[subIndex][field] = value; if(field === 'status') { submissions[subIndex].lastModified = new Date().toISOString(); await database.ref(`submissions/${firebaseId}/lastModified`).set(submissions[subIndex].lastModified); if (value === 'completed' && oldStatus !== 'completed') { const notes = submissions[subIndex].notes; if (notes) { await parseNotesAndDecreaseStock(notes); } } } } updateAllViews(); } catch (error) { console.error(`Error updating field "${field}":`, error); } }
        async function updateResource(name, field, value) { if (!database) return; try { await database.ref(`resources/${name}/${field}`).set(Number(value)); if (resources[name]) resources[name][field] = Number(value); renderResources(); } catch (error) { console.error("Error updating resource:", error); } }
        async function addNewResource() { const name = document.getElementById('newResourceName').value.trim(); const minStock = document.getElementById('newResourceMinStock').value.trim(); if (name && !resources.hasOwnProperty(name)) { await database.ref(`resources/${name}`).set({ quantity: 0, minStock: Number(minStock) || 0 }); resources[name] = { quantity: 0, minStock: Number(minStock) || 0 }; document.getElementById('newResourceName').value = ''; document.getElementById('newResourceMinStock').value = ''; renderResources(); } else if (resources.hasOwnProperty(name)) { alert("Bu kaynak zaten mevcut."); } }

        function updateAllViews() { loadSubmissionsList(); renderResources(); if (userData && userData.role === 'superadmin') { renderCoordinators(); } }
        
        function renderResources() { const list = document.getElementById('resourcesList'); list.innerHTML = ''; if(Object.keys(resources).length === 0) { list.innerHTML = `<p class="text-gray-500">Henüz kaynak eklenmemiş.</p>`; return; } for (const [name, data] of Object.entries(resources)) { const isLow = data.quantity <= data.minStock; list.innerHTML += `<div class="flex items-center justify-between p-3 glass-panel rounded-lg ${isLow ? 'border-2 border-red-500' : ''}"><span class="font-semibold text-gray-800">${name} ${isLow ? `<i class="fas fa-exclamation-triangle text-red-500 ml-2" title="Stok kritik seviyede!"></i>` : ''}</span><div class="flex items-center space-x-2"><label class="text-xs text-gray-700">Min:</label><input type="number" value="${data.minStock}" onchange="updateResource('${name}', 'minStock', this.value)" class="w-16 text-center p-1 border-none rounded-md"><label class="text-xs text-gray-700">Stok:</label><input type="number" value="${data.quantity}" onchange="updateResource('${name}', 'quantity', this.value)" class="w-16 text-center p-1 border-none rounded-md"></div></div>`; } }
        function renderCoordinators() { const list = document.getElementById('coordinatorsList'); list.innerHTML = ''; if (coordinators.length === 0) { list.innerHTML = '<p class="text-gray-500">Henüz koordinatör eklenmemiş.</p>'; return; } coordinators.forEach(c => { const roleLabel = { superadmin: 'Super Admin', coordinator: 'Koordinatör', pending: 'Onay Bekliyor'}[c.role] || c.role; const color = c.role === 'superadmin' ? 'text-turquoise-600' : c.role === 'pending' ? 'text-yellow-600' : 'text-gray-700'; list.innerHTML += `<div class="flex items-center justify-between p-3 glass-panel rounded-lg"><div class="flex-1"><p class="font-semibold text-gray-800">${c.email}</p><p class="text-sm ${color} font-medium">${roleLabel}</p></div><span class="text-sm text-gray-700">${c.district || 'Atanmamış'}</span><button onclick="editCoordinator('${c.email}', '${c.role}', '${c.district}')" class="p-2 rounded-full text-blue-600"><i class="fas fa-edit"></i></button></div>`; }); }
        function editCoordinator(email, role, district) { document.getElementById('coordinatorEmail').value = email; document.getElementById('coordinatorRole').value = role; document.getElementById('coordinatorDistrict').value = district || ''; }
        
        function handleFormSubmit(e) { e.preventDefault(); const name = document.getElementById('name').value.trim(); const phone = document.getElementById('phone').value.trim(); if (!name || !phone) { document.getElementById('errorMessage').classList.remove('hidden'); setTimeout(() => document.getElementById('errorMessage').classList.add('hidden'), 3000); return; } const needsCheckboxes = document.querySelectorAll('input[name="needs"]:checked'); const needs = {}; needsCheckboxes.forEach(checkbox => { needs[checkbox.value] = true; }); const today = new Date(); const datePart = today.toISOString().slice(0, 10).replace(/-/g, ''); const timePart = today.getTime().toString().slice(-5); const newSubmission = { submissionId: `${datePart}-${timePart}`, name, phone, address: document.getElementById('address').value.trim(), district: document.getElementById('district').value, needs, otherNeed: needs.other ? document.getElementById('otherNeed').value.trim() : '', urgency: document.querySelector('input[name="urgency"]:checked').value, description: document.getElementById('description').value.trim(), timestamp: today.toISOString(), status: 'new', notes: '', submittedBy: currentUser.uid }; saveSubmissionToFirebase(newSubmission); document.getElementById('needsForm').reset(); document.getElementById('otherNeedContainer').classList.add('hidden'); }
        
        async function generateActionPlan(firebaseId, type) { /* ... implementation from previous step ... */ }
        
        function printSubmission(firebaseId) { /* ... implementation from previous step ... */ }
        function confirmClearAllData() { if (confirm('Tüm verileri silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!')) { if (confirm('Son kez onaylıyor musunuz? Tüm başvuru kayıtları kalıcı olarak silinecek!')) { clearAllData(); } } }
        async function clearAllData() { if (!database) return; try { await database.ref('submissions').set(null); await database.ref('resources').set(null); submissions = []; resources = {}; updateAllViews(); alert('Tüm veriler başarıyla silindi!'); } catch (error) { console.error("Veri temizlenirken hata:", error); } }
        
        function exportToCSV(dataToExport, filenamePrefix) {
             if (!dataToExport || dataToExport.length === 0) return;
             const headers = ['Başvuru No','Durum','Ad Soyad','Telefon','Adres','İlçe','Gıda','Sağlık','Eğitim','Barınma','İstihdam','Hukuk','Diğer','Diğer İhtiyaç','Aciliyet','Açıklama','Notlar','Tarih'];
             const csvContent = [ headers.join(','), ...dataToExport.map(sub => { const needs = sub.needs || {}; return [`"${sub.submissionId || ''}"`,`"${statusMap[sub.status] || 'Bilinmiyor'}"`,`"${sub.name || ''}"`,`"${sub.phone || ''}"`,`"${sub.address || ''}"`,`"${sub.district || ''}"`,needs.food?'Evet':'Hayır',needs.health?'Evet':'Hayır',needs.education?'Evet':'Hayır',needs.housing?'Evet':'Hayır',needs.employment?'Evet':'Hayır',needs.legal?'Evet':'Hayır',needs.other?'Evet':'Hayır',`"${sub.otherNeed||''}"`,sub.urgency==='urgent'?'Acil':sub.urgency==='high'?'Yüksek':'Normal',`"${(sub.description||'').replace(/"/g,'""')}"`,`"${(sub.notes||'').replace(/"/g,'""')}"`,`"${new Date(sub.timestamp).toLocaleString('tr-TR')}"`].join(','); })].join('\n'); const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.setAttribute('href', url); link.setAttribute('download', `${filenamePrefix}_${new Date().toISOString().split('T')[0]}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); }

        function populateDistrictDropdown() { const select = document.getElementById('district'); if(!select) return; anadoluDistricts.sort().forEach(d => { select.innerHTML += `<option value="${d}">${d}</option>`; }); }
        function populateCoordinatorDistrictDropdown() { const select = document.getElementById('coordinatorDistrict'); if(!select) return; anadoluDistricts.sort().forEach(d => { if(d !== 'Ataşehir') select.innerHTML += `<option value="${d}">${d}</option>`; }); select.innerHTML += `<option value="Hepsi">Hepsi (Super Admin)</option>`; }
        function populateStatusFilterDropdown() { const statusFilter = document.getElementById('filterStatus'); if(!statusFilter) return; for (const [key, value] of Object.entries(statusMap)) { const option = document.createElement('option'); option.value = key; option.textContent = value; statusFilter.appendChild(option); } }
        
        function updateDistrictFilters() {
            const filterSelect = document.getElementById('filterDistrict');
            if (userData.role === 'superadmin') {
                filterSelect.classList.add('super-admin-visible');
                filterSelect.innerHTML = '<option value="all">Tüm İlçeler</option>';
                anadoluDistricts.sort().forEach(d => { filterSelect.innerHTML += `<option value="${d}">${d}</option>`; });
                filterSelect.disabled = false;
            } else {
                filterSelect.classList.add('admin-visible'); // Sadece görünür yap, super-admin değil
                filterSelect.classList.remove('super-admin-visible');
                filterSelect.innerHTML = `<option value="${userData.district}">${userData.district}</option>`;
                filterSelect.value = userData.district;
                filterSelect.disabled = true;
            }
        }

        function showApplicantHistory(phone, name) { /* ... implementation from previous step ... */ }
        
        function openSmsModal(firebaseId) { /* ... implementation from previous step ... */ }
        function generateSmsMessage(message) { document.getElementById('smsContent').value = message; }
        function copySmsContent() { const content = document.getElementById('smsContent'); content.select(); document.execCommand('copy'); alert('Mesaj panoya kopyalandı!'); }

        function loadSubmissionsList() { const listContainer = document.getElementById('submissionsList'); if(!listContainer) return; listContainer.innerHTML = ''; const searchTerm = document.getElementById('searchInput').value.toLowerCase(); const statusFilter = document.getElementById('filterStatus').value; const urgencyFilter = document.getElementById('filterUrgency').value; const districtFilter = document.getElementById('filterDistrict').value; let filteredSubmissions = submissions.filter(sub => { const nameMatch = (sub.name || '').toLowerCase().includes(searchTerm); const phoneMatch = (sub.phone || '').includes(searchTerm); const statusMatch = statusFilter === 'all' || sub.status === statusFilter; const urgencyMatch = urgencyFilter === 'all' || sub.urgency === urgencyFilter; let districtMatch = true; if (userData.role === 'superadmin') { districtMatch = (districtFilter === 'all' || sub.district === districtFilter); } else { districtMatch = (sub.district === userData.district); } return (nameMatch || phoneMatch) && statusMatch && urgencyMatch && districtMatch; }); document.getElementById('noSubmissions').classList.toggle('hidden', filteredSubmissions.length > 0); document.getElementById('submissionsCount').textContent = filteredSubmissions.length; const sortedSubmissions = filteredSubmissions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); sortedSubmissions.forEach(sub => { const needsLabels = {food:'Gıda',health:'Sağlık',education:'Eğitim',housing:'Barınma',employment:'İstihdam',legal:'Hukuk',other:'Diğer'}; const needsList = sub.needs ? Object.keys(sub.needs).map(need => needsLabels[need]).join(', ') : 'Belirtilmemiş'; let statusDropdownHTML = `<select onchange="updateSubmissionField('${sub.firebaseId}', 'status', this.value)" class="w-full p-1 border-none rounded-md text-sm">`; for (const [key, value] of Object.entries(statusMap)) { statusDropdownHTML += `<option value="${key}" ${sub.status === key ? 'selected' : ''}>${value}</option>`; } statusDropdownHTML += `</select>`; const el = document.createElement('div'); el.className = 'glass-panel rounded-xl p-4'; el.innerHTML = `<div class="flex justify-between items-center mb-3"><div class="flex-1"><h3 class="font-semibold text-gray-900">${sub.name}</h3><div class="flex items-center space-x-2"><p class="text-sm text-gray-800">${sub.phone}</p><button onclick="showApplicantHistory('${sub.phone}', '${sub.name}')" title="Kişi Geçmişi" class="text-xs text-turquoise-600"><i class="fas fa-history"></i></button><button onclick="openSmsModal('${sub.firebaseId}')" title="Hızlı SMS" class="text-xs text-turquoise-600"><i class="fas fa-comment-sms"></i></button></div><p class="text-xs text-gray-500 mt-1">#${sub.submissionId}</p></div><div class="flex items-center space-x-2"><span class="status-badge ${statusColors[sub.status]||'bg-gray-200'}">${statusMap[sub.status]||sub.status}</span><button onclick="printSubmission('${sub.firebaseId}')" class="p-2 rounded-full glass-panel text-gray-800" title="Yazdır"><i class="fas fa-print"></i></button></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3"><p class="text-sm text-gray-800 font-medium"><i class="fas fa-map-marker-alt mr-2 text-gray-400"></i>${sub.address||'...'}</p><p class="text-sm text-gray-800 font-medium"><i class="fas fa-city mr-2 text-gray-400"></i>${sub.district||'...'}</p><p class="text-sm text-gray-800 font-medium"><i class="fas fa-list mr-2 text-gray-400"></i>${needsList}</p>${sub.otherNeed?`<p class="text-sm text-gray-800 font-medium"><i class="fas fa-plus mr-2 text-gray-400"></i>${sub.otherNeed}</p>`:''}</div>${sub.description?`<p class="text-sm font-medium text-gray-900 glass-panel p-3 rounded-lg mb-3">${sub.description}</p>`:''}<div class="border-t border-gray-200 pt-3 mt-3 space-y-3"><div id="ai-plan-${sub.firebaseId}" class="hidden p-3 bg-blue-50 text-blue-800 rounded-lg text-sm"></div><button id="ai-btn-${sub.firebaseId}" onclick="generateActionPlan('${sub.firebaseId}', 'plan')" class="w-full text-sm bg-blue-100 text-blue-800 px-3 py-2 rounded-lg hover:bg-blue-200 font-semibold">✨ Eylem Planı Oluştur</button><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div class="md:col-span-2"><label class="block text-xs font-semibold text-gray-700 mb-1">İşlem Notları</label><div class="flex items-center space-x-2"><textarea id="notes-${sub.firebaseId}" class="w-full text-sm p-2 border-none rounded-md" rows="2">${sub.notes||''}</textarea><button id="ai-summary-btn-${sub.firebaseId}" onclick="generateActionPlan('${sub.firebaseId}', 'summary')" title="Notları Özetle" class="p-2 rounded-full glass-panel text-blue-600">✨</button></div><button onclick="updateSubmissionField('${sub.firebaseId}','notes',document.getElementById('notes-${sub.firebaseId}').value)" class="mt-1 text-xs bg-turquoise-100 text-turquoise-800 px-2 py-1 rounded hover:bg-turquoise-200">Notu Kaydet</button></div><div><label class="block text-xs font-semibold text-gray-700 mb-1">Durumu Değiştir</label>${statusDropdownHTML}</div></div></div><p class="text-xs text-gray-500 mt-3 text-right"><i class="fas fa-clock mr-1"></i>${new Date(sub.timestamp).toLocaleString('tr-TR')}</p>`; listContainer.appendChild(el); }); }
        
        async function parseNotesAndDecreaseStock(notesText) { if (!notesText) return; let updatesMade = false; let updateSummary = []; const currentResources = { ...resources }; for (const resourceName in currentResources) { const escapedResourceName = resourceName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); const regex = new RegExp(`(\\d+)\\s*(?:x|adet|paket|tane)?\\s*${escapedResourceName}|${escapedResourceName}\\s*x\\s*(\\d+)`, "i"); const match = notesText.match(regex); if (match) { const quantityToDecrease = parseInt(match[1] || match[2], 10); if (!isNaN(quantityToDecrease) && quantityToDecrease > 0) { const currentStock = currentResources[resourceName].quantity || 0; const newStock = currentStock - quantityToDecrease; await updateResource(resourceName, 'quantity', newStock); resources[resourceName].quantity = newStock; updateSummary.push(`${resourceName}: -${quantityToDecrease}`); updatesMade = true; } } } if (updatesMade) { renderResources(); alert("Stok güncellendi:\n" + updateSummary.join("\n")); } }
        
        function initializeReportsTab() {
            const daterangeContent = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 items-end"><div><label class="block text-sm font-medium text-gray-900 mb-2">Başlangıç</label><input type="date" id="reportDateStart" class="w-full px-4 py-2 border-none rounded-lg"></div><div><label class="block text-sm font-medium text-gray-900 mb-2">Bitiş</label><input type="date" id="reportDateEnd" class="w-full px-4 py-2 border-none rounded-lg"></div><button id="generateReportBtn" class="w-full bg-turquoise-600 text-white py-2 px-4 rounded-lg font-semibold shadow-md">Rapor Oluştur</button></div><div id="dailyReportContent" class="glass-panel rounded-xl p-6 hidden"><h3 class="text-lg font-semibold text-gray-900 mb-4">Rapor: <span id="reportDateDisplay"></span></h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"><div class="glass-panel p-4 rounded-lg"><h4 class="font-medium text-gray-800">Toplam Başvuru</h4><p id="reportTotal" class="text-2xl font-bold text-gray-900">0</p></div><div class="glass-panel p-4 rounded-lg"><h4 class="font-medium text-gray-800">Acil Durumlar</h4><p id="reportUrgent" class="text-2xl font-bold text-gray-900">0</p></div><div class="glass-panel p-4 rounded-lg"><h4 class="font-medium text-gray-800">En Çok İhtiyaç</h4><p id="reportTopNeed" class="text-lg font-medium text-gray-900">-</p></div></div><div class="mb-4"><h4 class="font-medium text-gray-900 mb-2">İhtiyaç Dağılımı</h4><div id="reportNeedsChart" class="space-y-2"></div></div><button id="exportReportBtn" class="bg-turquoise-600 text-white px-4 py-2 rounded-lg shadow-md"><i class="fas fa-download mr-2"></i>İndir</button></div><div id="noReportData" class="text-center py-8 text-gray-500"><i class="fas fa-file-alt text-4xl mb-4"></i><p>Tarih aralığı seçip "Rapor Oluştur" butonuna basın.</p></div>`;
            const calendarContent = `<div class="flex items-center justify-between mb-4"><button id="prevMonthBtn" class="p-2 rounded-full glass-panel"><i class="fas fa-chevron-left"></i></button><h3 id="monthYearDisplay" class="text-lg font-semibold text-gray-900"></h3><button id="nextMonthBtn" class="p-2 rounded-full glass-panel"><i class="fas fa-chevron-right"></i></button></div><div id="geminiAnalyzeContainer" class="my-4"></div><div class="grid grid-cols-7 gap-2 text-center font-semibold text-gray-700 mb-2"><div>Pzt</div><div>Sal</div><div>Çar</div><div>Per</div><div>Cum</div><div>Cmt</div><div>Paz</div></div><div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>`;
            const neighborhoodContent = `<div id="neighborhoodAnalysis" class="space-y-4"></div>`;
            document.getElementById('reportsSection').querySelector('#daterange-report-content').innerHTML = daterangeContent;
            document.getElementById('reportsSection').querySelector('#calendar-report-content').innerHTML = calendarContent;
            document.getElementById('reportsSection').querySelector('#neighborhood-report-content').innerHTML = neighborhoodContent;
            document.getElementById('generateReportBtn').addEventListener('click', generateReportByDateRange);
            document.getElementById('prevMonthBtn').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth()); });
            document.getElementById('nextMonthBtn').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth()); });
            document.getElementById('tab-daterange').addEventListener('click', switchReportTab);
            document.getElementById('tab-calendar').addEventListener('click', switchReportTab);
            document.getElementById('tab-neighborhood').addEventListener('click', switchReportTab);
            renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
        }

        function switchReportTab(e) {
            const tabs = ['tab-daterange', 'tab-calendar', 'tab-neighborhood'];
            const contents = ['daterange-report-content', 'calendar-report-content', 'neighborhood-report-content'];
            const selectedTab = e.target.id;
            
            tabs.forEach(tabId => {
                const tab = document.getElementById(tabId);
                const isSelected = tabId === selectedTab;
                tab.classList.toggle('border-turquoise-500', isSelected);
                tab.classList.toggle('text-turquoise-600', isSelected);
                tab.classList.toggle('border-transparent', !isSelected);
                tab.classList.toggle('text-gray-500', !isSelected);
            });

            contents.forEach(contentId => {
                document.getElementById(contentId).classList.toggle('hidden', contentId !== `${selectedTab.split('-')[1]}-report-content`);
            });

            if (selectedTab === 'tab-neighborhood') {
                renderNeighborhoodAnalysis();
            }
        }

        function renderCalendar(year, month) {
            const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
            document.getElementById('monthYearDisplay').textContent = `${monthNames[month]} ${year}`;
            const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dayOffset = (firstDay === 0) ? 6 : firstDay - 1;
            for (let i = 0; i < dayOffset; i++) { grid.innerHTML += '<div></div>'; }
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toISOString().split('T')[0];
                const daySubmissions = submissions.filter(s => s.timestamp.startsWith(dateString));
                const count = daySubmissions.length;
                let cellClass = 'glass-panel p-2 rounded-lg text-left h-24 flex flex-col justify-between';
                if(count > 0) cellClass += ' bg-turquoise-100/50 dark:bg-turquoise-900/50';
                grid.innerHTML += `<div class="${cellClass}"><span class="font-bold text-gray-900">${day}</span>${count > 0 ? `<span class="text-xs text-turquoise-700 font-semibold">${count} başvuru</span>` : ''}</div>`;
            }
            const analyzeContainer = document.getElementById('geminiAnalyzeContainer');
            analyzeContainer.innerHTML = `<button onclick="analyzeMonthWithGemini(${year}, ${month})" class="w-full text-sm bg-blue-100 text-blue-800 px-3 py-2 rounded-lg hover:bg-blue-200 font-semibold">✨ ${monthNames[month]} Ayını Analiz Et</button>`;
        }
        
        function generateReportByDateRange() { /* ... implementation from previous step ... */ }
        function renderNeighborhoodAnalysis() { /* ... implementation from previous step ... */ }
        async function analyzeMonthWithGemini(year, month) { /* ... implementation from previous step ... */ }
    </script>
</body>
</html>

